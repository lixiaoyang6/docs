<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>My Awesome Project111</title>
    <meta name="description" content="A VitePress Site111">
    <meta name="generator" content="VitePress v1.6.3">
    <link rel="preload stylesheet" href="/docs/assets/style.cnti6-_j.css" as="style">
    <link rel="preload stylesheet" href="/docs/vp-icons.css" as="style">
    
    <script type="module" src="/docs/assets/app.CLZvkcRc.js"></script>
    <link rel="preload" href="/docs/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/docs/assets/chunks/theme.lc_Cxh5u.js">
    <link rel="modulepreload" href="/docs/assets/chunks/framework.Ddj9Gik_.js">
    <link rel="modulepreload" href="/docs/assets/file-note.md.Bma2zlnX.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-9e0dc340><!--[--><!--]--><!--[--><span tabindex="-1" data-v-e72996d2></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-e72996d2>Skip to content</a><!--]--><!----><header class="VPNav" data-v-9e0dc340 data-v-1d1b96ff><div class="VPNavBar" data-v-1d1b96ff data-v-4d800dfc><div class="wrapper" data-v-4d800dfc><div class="container" data-v-4d800dfc><div class="title" data-v-4d800dfc><div class="VPNavBarTitle has-sidebar" data-v-4d800dfc data-v-89a89e84><a class="title" href="/docs/" data-v-89a89e84><!--[--><!--]--><!----><span data-v-89a89e84>My Awesome Project111</span><!--[--><!--]--></a></div></div><div class="content" data-v-4d800dfc><div class="content-body" data-v-4d800dfc><!--[--><!--]--><div class="VPNavBarSearch search" data-v-4d800dfc><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-4d800dfc data-v-607d5d3a><span id="main-nav-aria-label" class="visually-hidden" data-v-607d5d3a> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/docs/" tabindex="0" data-v-607d5d3a data-v-f1d0f200><!--[--><span data-v-f1d0f200>Home</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/docs/tracking-code.html" tabindex="0" data-v-607d5d3a data-v-f1d0f200><!--[--><span data-v-f1d0f200>埋点代码</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-4d800dfc data-v-2c13f456><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-2c13f456 data-v-d05a415d data-v-379eabd0><span class="check" data-v-379eabd0><span class="icon" data-v-379eabd0><!--[--><span class="vpi-sun sun" data-v-d05a415d></span><span class="vpi-moon moon" data-v-d05a415d></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-4d800dfc data-v-2e1573c1 data-v-d88654af><!--[--><a class="VPSocialLink no-icon" href="https://github.com/vuejs/vitepress" aria-label="github" target="_blank" rel="noopener" data-v-d88654af data-v-f0f10363><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-4d800dfc data-v-bef107a0 data-v-946f6a59><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-946f6a59><span class="vpi-more-horizontal icon" data-v-946f6a59></span></button><div class="menu" data-v-946f6a59><div class="VPMenu" data-v-946f6a59 data-v-0089a6cb><!----><!--[--><!--[--><!----><div class="group" data-v-bef107a0><div class="item appearance" data-v-bef107a0><p class="label" data-v-bef107a0>Appearance</p><div class="appearance-action" data-v-bef107a0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bef107a0 data-v-d05a415d data-v-379eabd0><span class="check" data-v-379eabd0><span class="icon" data-v-379eabd0><!--[--><span class="vpi-sun sun" data-v-d05a415d></span><span class="vpi-moon moon" data-v-d05a415d></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bef107a0><div class="item social-links" data-v-bef107a0><div class="VPSocialLinks social-links-list" data-v-bef107a0 data-v-d88654af><!--[--><a class="VPSocialLink no-icon" href="https://github.com/vuejs/vitepress" aria-label="github" target="_blank" rel="noopener" data-v-d88654af data-v-f0f10363><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-4d800dfc data-v-0c7f538f><span class="container" data-v-0c7f538f><span class="top" data-v-0c7f538f></span><span class="middle" data-v-0c7f538f></span><span class="bottom" data-v-0c7f538f></span></span></button></div></div></div></div><div class="divider" data-v-4d800dfc><div class="divider-line" data-v-4d800dfc></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-9e0dc340 data-v-33e2424d><div class="container" data-v-33e2424d><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-33e2424d><span class="vpi-align-left menu-icon" data-v-33e2424d></span><span class="menu-text" data-v-33e2424d>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-33e2424d data-v-3542b315><button data-v-3542b315>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-9e0dc340 data-v-92835146><div class="curtain" data-v-92835146></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-92835146><span class="visually-hidden" id="sidebar-aria-label" data-v-92835146> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-a63daa2b><section class="VPSidebarItem level-0 has-active" data-v-a63daa2b data-v-a245444e><div class="item" role="button" tabindex="0" data-v-a245444e><div class="indicator" data-v-a245444e></div><h2 class="text" data-v-a245444e>文件上传</h2><!----></div><div class="items" data-v-a245444e><!--[--><div class="VPSidebarItem level-1 is-link" data-v-a245444e data-v-a245444e><div class="item" data-v-a245444e><div class="indicator" data-v-a245444e></div><a class="VPLink link link" href="/docs/file-code.html" data-v-a245444e><!--[--><p class="text" data-v-a245444e>文件上传代码</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a245444e data-v-a245444e><div class="item" data-v-a245444e><div class="indicator" data-v-a245444e></div><a class="VPLink link link" href="/docs/file-note.html" data-v-a245444e><!--[--><p class="text" data-v-a245444e>文件上传笔记</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-a63daa2b><section class="VPSidebarItem level-0" data-v-a63daa2b data-v-a245444e><div class="item" role="button" tabindex="0" data-v-a245444e><div class="indicator" data-v-a245444e></div><h2 class="text" data-v-a245444e>埋点</h2><!----></div><div class="items" data-v-a245444e><!--[--><div class="VPSidebarItem level-1 is-link" data-v-a245444e data-v-a245444e><div class="item" data-v-a245444e><div class="indicator" data-v-a245444e></div><a class="VPLink link link" href="/docs/tracking-code.html" data-v-a245444e><!--[--><p class="text" data-v-a245444e>埋点核心代码</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a245444e data-v-a245444e><div class="item" data-v-a245444e><div class="indicator" data-v-a245444e></div><a class="VPLink link link" href="/docs/tracking-note.html" data-v-a245444e><!--[--><p class="text" data-v-a245444e>埋点笔记</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-a63daa2b><section class="VPSidebarItem level-0" data-v-a63daa2b data-v-a245444e><div class="item" role="button" tabindex="0" data-v-a245444e><div class="indicator" data-v-a245444e></div><h2 class="text" data-v-a245444e>jQuery</h2><!----></div><div class="items" data-v-a245444e><!--[--><div class="VPSidebarItem level-1 is-link" data-v-a245444e data-v-a245444e><div class="item" data-v-a245444e><div class="indicator" data-v-a245444e></div><a class="VPLink link link" href="/docs/jq-code.html" data-v-a245444e><!--[--><p class="text" data-v-a245444e>jQuery代码</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-9e0dc340 data-v-eb1b7899><div class="VPDoc has-sidebar has-aside" data-v-eb1b7899 data-v-4a2b1bc7><!--[--><!--]--><div class="container" data-v-4a2b1bc7><div class="aside" data-v-4a2b1bc7><div class="aside-curtain" data-v-4a2b1bc7></div><div class="aside-container" data-v-4a2b1bc7><div class="aside-content" data-v-4a2b1bc7><div class="VPDocAside" data-v-4a2b1bc7 data-v-988c121c><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-988c121c data-v-60325de8><div class="content" data-v-60325de8><div class="outline-marker" data-v-60325de8></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-60325de8>On this page</div><ul class="VPDocOutlineItem root" data-v-60325de8 data-v-f8c1321c><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-988c121c></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-4a2b1bc7><div class="content-container" data-v-4a2b1bc7><!--[--><!--]--><main class="main" data-v-4a2b1bc7><div style="position:relative;" class="vp-doc _docs_file-note" data-v-4a2b1bc7><div><h2 id="秒传" tabindex="-1">秒传 <a class="header-anchor" href="#秒传" aria-label="Permalink to &quot;秒传&quot;">​</a></h2><p>“秒传”是网络传输中的一个概念，通常指文件在极短的时间内完成上传或下载，几乎达到“瞬间传输”的效果。具体应用场景和实现原理因平台而异，以下是详细解析：</p><hr><h3 id="_1-常见场景" tabindex="-1">1. <strong>常见场景</strong> <a class="header-anchor" href="#_1-常见场景" aria-label="Permalink to &quot;1. **常见场景**&quot;">​</a></h3><ul><li><strong>网盘秒传</strong>（如百度网盘、阿里云盘等）： <ul><li><strong>原理</strong>：利用文件哈希值（如MD5、SHA1）校验。当用户上传文件时，系统会先计算文件的唯一指纹，若服务器已存在相同文件，则直接关联到你的账户，无需重复上传。</li><li><strong>效果</strong>：即使文件大小是1GB，也可能“秒传”完成，实际是跳过了物理传输步骤。</li><li><strong>限制</strong>：仅对服务器已有的文件有效，新文件仍需正常上传。</li></ul></li><li><strong>P2P秒传</strong>（如迅雷、BT下载）： <ul><li>当其他用户已下载过相同文件，你可直接从本地网络节点快速获取，速度远超常规下载。</li></ul></li><li><strong>即时通讯工具</strong>（如微信/QQ发文件）： <ul><li>若文件已存在于服务器缓存中，可能会显示“秒传”，实际是服务器快速响应。</li></ul></li></ul><hr><h3 id="_2-技术核心" tabindex="-1">2. <strong>技术核心</strong> <a class="header-anchor" href="#_2-技术核心" aria-label="Permalink to &quot;2. **技术核心**&quot;">​</a></h3><ul><li><strong>哈希校验</strong>：通过算法（如MD5）生成文件唯一标识，匹配服务器数据。</li><li><strong>去重存储</strong>：云端仅保存一份相同文件，多个用户共享同一数据源。</li></ul><hr><h3 id="_3-用户需注意" tabindex="-1">3. <strong>用户需注意</strong> <a class="header-anchor" href="#_3-用户需注意" aria-label="Permalink to &quot;3. **用户需注意**&quot;">​</a></h3><ul><li><strong>隐私问题</strong>：秒传意味着你的文件可能已被他人上传过，需警惕敏感文件泄露风险。</li><li><strong>平台差异</strong>：并非所有文件都能秒传，新文件仍需完整上传。</li></ul><hr><h3 id="_4-为什么需要秒传" tabindex="-1">4. <strong>为什么需要秒传？</strong> <a class="header-anchor" href="#_4-为什么需要秒传" aria-label="Permalink to &quot;4. **为什么需要秒传？**&quot;">​</a></h3><ul><li><strong>节省带宽</strong>：降低服务器和用户流量消耗。</li><li><strong>提升效率</strong>：避免重复传输，尤其对大文件共享至关重要。</li></ul><p>若你遇到具体的秒传问题（如失效或操作困惑），可进一步说明场景，我会提供针对性解答。</p><h2 id="通过算法-如md5-生成文件唯一标识-匹配服务器数" tabindex="-1">通过算法（如MD5）生成文件唯一标识，匹配服务器数 <a class="header-anchor" href="#通过算法-如md5-生成文件唯一标识-匹配服务器数" aria-label="Permalink to &quot;通过算法（如MD5）生成文件唯一标识，匹配服务器数&quot;">​</a></h2><p>好的！我来详细解释「<strong>通过算法（如MD5）生成文件唯一标识，匹配服务器数据</strong>」这一技术原理，以及它在秒传中的具体应用流程。</p><hr><h3 id="核心逻辑" tabindex="-1"><strong>核心逻辑</strong> <a class="header-anchor" href="#核心逻辑" aria-label="Permalink to &quot;**核心逻辑**&quot;">​</a></h3><p>秒传的关键在于 <strong>文件内容去重</strong>。系统通过计算文件的唯一指纹（哈希值），快速判断服务器是否已存在相同文件。若存在，则直接关联文件到用户账户，无需重复上传。</p><hr><h3 id="具体步骤分解" tabindex="-1"><strong>具体步骤分解</strong> <a class="header-anchor" href="#具体步骤分解" aria-label="Permalink to &quot;**具体步骤分解**&quot;">​</a></h3><h4 id="_1-生成文件唯一标识-哈希值" tabindex="-1"><strong>1. 生成文件唯一标识（哈希值）</strong> <a class="header-anchor" href="#_1-生成文件唯一标识-哈希值" aria-label="Permalink to &quot;**1. 生成文件唯一标识（哈希值）**&quot;">​</a></h4><ul><li><strong>算法选择</strong>：使用哈希算法（如MD5、SHA1、SHA256）对文件内容进行计算。 <ul><li><strong>MD5</strong>：生成128位（16字节）哈希值，表示为32位十六进制字符串（如 <code>d41d8cd98f00b204e9800998ecf8427e</code>）。</li><li><strong>SHA1</strong>：生成160位哈希值，碰撞概率更低，但计算稍慢。</li></ul></li><li><strong>计算原理</strong>： <ul><li>哈希算法会将文件内容（无论大小）转换为固定长度的字符串。</li><li><strong>关键特性</strong>：只要文件内容发生<strong>任何微小改动</strong>（如修改一个字节），哈希值就会完全不同。</li><li><strong>唯一性</strong>：理论上不同文件的哈希值可能相同（哈希碰撞），但概率极低（如MD5碰撞概率约 (1.47 \times 10^{-29})）。</li></ul></li></ul><h4 id="_2-客户端与服务器的交互" tabindex="-1"><strong>2. 客户端与服务器的交互</strong> <a class="header-anchor" href="#_2-客户端与服务器的交互" aria-label="Permalink to &quot;**2. 客户端与服务器的交互**&quot;">​</a></h4><ol><li><p><strong>客户端准备上传文件</strong>：</p><ul><li>用户选择文件后，客户端（如网盘软件）<strong>先计算文件的哈希值</strong>（例如MD5）。</li><li>示例：上传一个1GB的视频文件，客户端可能需要几秒到几分钟计算其MD5（取决于硬件性能）。</li></ul></li><li><p><strong>向服务器发起查询</strong>：</p><ul><li>客户端将文件的哈希值发送给服务器，询问：“服务器是否已存在相同哈希值的文件？”</li><li><strong>注意</strong>：此时仅传输哈希值（几十字节），而非整个文件。</li></ul></li><li><p><strong>服务器检查哈希值</strong>：</p><ul><li>服务器在数据库中查找该哈希值： <ul><li><strong>如果存在</strong>：说明服务器已存储相同内容的文件，直接将该文件“映射”到用户账户，秒传完成。</li><li><strong>如果不存在</strong>：通知客户端需完整上传文件。</li></ul></li></ul></li></ol><hr><h3 id="实际案例-以百度网盘为例" tabindex="-1"><strong>实际案例（以百度网盘为例）</strong> <a class="header-anchor" href="#实际案例-以百度网盘为例" aria-label="Permalink to &quot;**实际案例（以百度网盘为例）**&quot;">​</a></h3><ol><li><p><strong>用户A上传文件</strong>：</p><ul><li>用户A上传一个文件 <code>movie.mp4</code>，百度网盘计算其MD5为 <code>abc123</code>。</li><li>服务器存储文件内容，并将MD5 <code>abc123</code> 记录在数据库中。</li></ul></li><li><p><strong>用户B上传相同文件</strong>：</p><ul><li>用户B上传相同的 <code>movie.mp4</code>，客户端计算MD5同样是 <code>abc123</code>。</li><li>服务器发现MD5 <code>abc123</code> 已存在，直接关联文件到用户B的账户，无需上传。</li></ul></li></ol><hr><h3 id="技术细节补充" tabindex="-1"><strong>技术细节补充</strong> <a class="header-anchor" href="#技术细节补充" aria-label="Permalink to &quot;**技术细节补充**&quot;">​</a></h3><h4 id="_1-为什么哈希值能代表文件唯一性" tabindex="-1"><strong>1. 为什么哈希值能代表文件唯一性？</strong> <a class="header-anchor" href="#_1-为什么哈希值能代表文件唯一性" aria-label="Permalink to &quot;**1. 为什么哈希值能代表文件唯一性？**&quot;">​</a></h4><ul><li>哈希算法的设计保证了： <ul><li><strong>确定性</strong>：相同输入必然得到相同输出。</li><li><strong>雪崩效应</strong>：微小改动会导致结果剧变。</li><li><strong>抗碰撞性</strong>：极难找到两个不同文件具有相同哈希值。</li></ul></li></ul><h4 id="_2-大文件的分块哈希" tabindex="-1"><strong>2. 大文件的分块哈希</strong> <a class="header-anchor" href="#_2-大文件的分块哈希" aria-label="Permalink to &quot;**2. 大文件的分块哈希**&quot;">​</a></h4><ul><li>对于超大文件（如10GB），部分系统（如百度网盘）会采用分块哈希： <ul><li>将文件切分为多个块（如每块4MB），分别计算每个块的MD5。</li><li>将所有块的MD5拼接后，再计算一次总MD5。</li><li><strong>优点</strong>：支持断点续传，同时减少哈希碰撞概率。</li></ul></li></ul><h4 id="_3-哈希算法的选择" tabindex="-1"><strong>3. 哈希算法的选择</strong> <a class="header-anchor" href="#_3-哈希算法的选择" aria-label="Permalink to &quot;**3. 哈希算法的选择**&quot;">​</a></h4><ul><li><strong>MD5</strong>：计算速度快，但已被证明存在理论碰撞可能（不过实际秒传场景中仍广泛使用）。</li><li><strong>SHA1</strong>：更安全，但计算时间稍长。</li><li><strong>混合策略</strong>：部分系统同时计算多个哈希值（如MD5+SHA1），进一步降低碰撞风险。</li></ul><hr><h3 id="潜在问题与限制" tabindex="-1"><strong>潜在问题与限制</strong> <a class="header-anchor" href="#潜在问题与限制" aria-label="Permalink to &quot;**潜在问题与限制**&quot;">​</a></h3><ol><li><p><strong>哈希碰撞风险</strong>：</p><ul><li>虽然概率极低，但若攻击者故意构造哈希碰撞的文件，可能导致数据错误。</li><li>应对措施：使用更安全的算法（如SHA256）或混合哈希。</li></ul></li><li><p><strong>隐私问题</strong>：</p><ul><li>若服务器通过哈希值匹配文件，意味着其他人可能已上传过相同文件。</li><li><strong>敏感文件警告</strong>：如果你上传的私密文件秒传成功，说明该文件已被他人上传过，存在泄露风险。</li></ul></li><li><p><strong>文件属性无关性</strong>：</p><ul><li>哈希值仅依赖文件内容，与文件名、修改时间等元数据无关。</li><li>即使你重命名文件，只要内容相同，仍会秒传。</li></ul></li></ol><hr><h3 id="总结" tabindex="-1"><strong>总结</strong> <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;**总结**&quot;">​</a></h3><p>通过哈希算法生成唯一标识，是秒传技术的核心原理。它依赖哈希值的唯一性和服务器的快速检索能力，实现了高效的去重传输。这种技术大幅节省了带宽和存储空间，但也带来了隐私方面的潜在风险。理解这一机制，能帮助你更好地使用网盘等工具，并规避可能的隐患。</p><h2 id="并发数量最大是6" tabindex="-1">并发数量最大是6 <a class="header-anchor" href="#并发数量最大是6" aria-label="Permalink to &quot;并发数量最大是6&quot;">​</a></h2><p>在 Web 前端开发中，“<strong>并发数量最大是 6</strong>”通常指的是浏览器对 <strong>同一域名（Origin）下的 HTTP/1.1 请求的并发连接数限制</strong>。这是浏览器的一种默认行为，目的是避免单个客户端对服务器造成过大压力，同时平衡性能和资源消耗。</p><hr><h3 id="_1-技术背景" tabindex="-1"><strong>1. 技术背景</strong> <a class="header-anchor" href="#_1-技术背景" aria-label="Permalink to &quot;**1. 技术背景**&quot;">​</a></h3><h4 id="http-1-1-的并发限制" tabindex="-1"><strong>HTTP/1.1 的并发限制</strong> <a class="header-anchor" href="#http-1-1-的并发限制" aria-label="Permalink to &quot;**HTTP/1.1 的并发限制**&quot;">​</a></h4><ul><li><strong>HTTP/1.1 协议</strong>：默认情况下，浏览器对 <strong>同一域名</strong> 下的请求会保持最多 <strong>6 个并发 TCP 连接</strong>。 <ul><li>如果同时发起第 7 个请求，浏览器会将其放入队列，直到之前的某个请求完成。</li><li>示例：加载一个网页时，如果有 10 张图片来自同一域名，前 6 张会并行下载，剩余 4 张需等待。</li></ul></li><li><strong>不同浏览器的差异</strong>： <ul><li>大多数现代浏览器（Chrome、Firefox、Edge）遵循 <strong>6 个并发连接数</strong> 的限制。</li><li>旧版浏览器（如 IE6-IE8）的并发数可能更低（如 2 个）。</li></ul></li></ul><h4 id="http-2-的改进" tabindex="-1"><strong>HTTP/2 的改进</strong> <a class="header-anchor" href="#http-2-的改进" aria-label="Permalink to &quot;**HTTP/2 的改进**&quot;">​</a></h4><ul><li><strong>多路复用（Multiplexing）</strong>：HTTP/2 允许在单个 TCP 连接上并行传输多个请求和响应，突破 HTTP/1.1 的并发数限制。 <ul><li>浏览器对同一域名的 HTTP/2 请求通常不再受 6 个并发的限制。</li><li>但实际并发数仍受浏览器实现和服务器配置的影响（例如 Chrome 默认限制为 256 个流）。</li></ul></li></ul><hr><h3 id="_2-为什么会有这个限制" tabindex="-1"><strong>2. 为什么会有这个限制？</strong> <a class="header-anchor" href="#_2-为什么会有这个限制" aria-label="Permalink to &quot;**2. 为什么会有这个限制？**&quot;">​</a></h3><ul><li><strong>防止服务器过载</strong>：避免单个客户端占用过多服务器资源。</li><li><strong>优化资源调度</strong>：浏览器需要平衡网络带宽、内存和 CPU 的使用。</li><li><strong>历史原因</strong>：HTTP/1.1 协议设计时未考虑高效的并发机制（如队头阻塞问题）。</li></ul><hr><h3 id="_3-对前端性能的影响" tabindex="-1"><strong>3. 对前端性能的影响</strong> <a class="header-anchor" href="#_3-对前端性能的影响" aria-label="Permalink to &quot;**3. 对前端性能的影响**&quot;">​</a></h3><h4 id="负面效果" tabindex="-1"><strong>负面效果</strong> <a class="header-anchor" href="#负面效果" aria-label="Permalink to &quot;**负面效果**&quot;">​</a></h4><ul><li><strong>资源加载延迟</strong>：如果页面需要加载大量静态资源（如图片、JS、CSS），超出 6 个并发数时，后续资源需排队等待。</li><li><strong>关键资源阻塞</strong>：若关键资源（如首屏渲染所需的 CSS/JS）被排在队列中，会延迟页面加载。</li></ul><h4 id="优化策略" tabindex="-1"><strong>优化策略</strong> <a class="header-anchor" href="#优化策略" aria-label="Permalink to &quot;**优化策略**&quot;">​</a></h4><ol><li><p><strong>域名分片（Domain Sharding）</strong>：</p><ul><li>将资源分散到多个子域名（如 <code>static1.example.com</code>、<code>static2.example.com</code>），每个子域名可拥有 6 个并发连接。</li><li><strong>注意</strong>：HTTP/2 下此方法可能适得其反（因为多域名会减少 HTTP/2 多路复用的优势）。</li></ul></li><li><p><strong>使用 HTTP/2</strong>：</p><ul><li>升级到 HTTP/2 或 HTTP/3，利用多路复用特性突破并发限制。</li><li>需要服务器支持（如 Nginx、CDN 服务默认已启用）。</li></ul></li><li><p><strong>合并资源</strong>：</p><ul><li>将多个小文件合并为单个文件（如合并 CSS/JS、使用雪碧图）。</li><li>减少请求数量，降低对并发数的依赖。</li></ul></li><li><p><strong>按需加载（Lazy Loading）</strong>：</p><ul><li>仅加载当前视口（Viewport）内的资源，非关键资源延迟加载。</li></ul></li><li><p><strong>使用异步/延迟加载标签</strong>：</p><ul><li><p>对非关键 JS 使用 <code>async</code> 或 <code>defer</code> 属性，避免阻塞其他资源。</p></li><li><p>示例：</p><div class="language-html vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> src</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;app.js&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">link</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> rel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;stylesheet&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> href</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;style.css&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> media</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;print&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">media</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;all&#39;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div></li></ul></li></ol><hr><h3 id="_4-验证并发限制" tabindex="-1"><strong>4. 验证并发限制</strong> <a class="header-anchor" href="#_4-验证并发限制" aria-label="Permalink to &quot;**4. 验证并发限制**&quot;">​</a></h3><h4 id="通过浏览器开发者工具" tabindex="-1"><strong>通过浏览器开发者工具</strong> <a class="header-anchor" href="#通过浏览器开发者工具" aria-label="Permalink to &quot;**通过浏览器开发者工具**&quot;">​</a></h4><ol><li>打开 Chrome DevTools → Network 面板。</li><li>勾选 <strong>Disable cache</strong>（避免缓存干扰）。</li><li>刷新页面，观察同一域名下请求的 <strong>Waterfall</strong>（瀑布流）： <ul><li>前 6 个请求并行下载，后续请求处于队列中（显示为灰色）。</li></ul></li></ol><h4 id="示例场景" tabindex="-1"><strong>示例场景</strong> <a class="header-anchor" href="#示例场景" aria-label="Permalink to &quot;**示例场景**&quot;">​</a></h4><ul><li>页面需加载 10 张图片（来自同一域名 <code>cdn.example.com</code>）： <ul><li>前 6 张立即开始下载。</li><li>第 7-10 张需等待前 6 个请求中的某个完成。</li></ul></li></ul><hr><h3 id="_5-总结" tabindex="-1"><strong>5. 总结</strong> <a class="header-anchor" href="#_5-总结" aria-label="Permalink to &quot;**5. 总结**&quot;">​</a></h3><ul><li><strong>前端并发数最大为 6</strong> 是浏览器对 HTTP/1.1 同一域名的默认并发限制。</li><li><strong>HTTP/2 可突破此限制</strong>，但需服务器和浏览器同时支持。</li><li><strong>优化方向</strong>：减少请求数量、升级协议、合理分配资源加载优先级。</li></ul><p>如果需要进一步分析具体页面的性能问题，可以结合浏览器开发者工具的 Network 面板进行诊断。</p><h2 id="断点续传详解" tabindex="-1">断点续传详解 <a class="header-anchor" href="#断点续传详解" aria-label="Permalink to &quot;断点续传详解&quot;">​</a></h2><p><strong>断点续传</strong>（Resumable Transfer）是一种在网络传输中允许用户从中断点继续传输文件的技术，无需从头开始重新上传或下载。它广泛应用于大文件传输场景（如云存储、视频上传、软件更新等），解决了网络不稳定或意外中断导致重复传输的问题。</p><hr><h3 id="_1-核心原理" tabindex="-1"><strong>1. 核心原理</strong> <a class="header-anchor" href="#_1-核心原理" aria-label="Permalink to &quot;**1. 核心原理**&quot;">​</a></h3><p>断点续传的核心是通过 <strong>分块传输</strong> 和 <strong>记录传输进度</strong> 来实现：</p><ul><li><strong>分块传输</strong>：将大文件切割为多个小块（Chunks），逐块传输。</li><li><strong>记录进度</strong>：客户端和服务端分别记录已传输的块信息，中断后可快速定位到未完成的部分。</li></ul><hr><h3 id="_2-实现流程-以上传为例" tabindex="-1"><strong>2. 实现流程（以上传为例）</strong> <a class="header-anchor" href="#_2-实现流程-以上传为例" aria-label="Permalink to &quot;**2. 实现流程（以上传为例）**&quot;">​</a></h3><h4 id="_2-1-初始化阶段" tabindex="-1"><strong>2.1 初始化阶段</strong> <a class="header-anchor" href="#_2-1-初始化阶段" aria-label="Permalink to &quot;**2.1 初始化阶段**&quot;">​</a></h4><ol><li><strong>文件分块</strong>： <ul><li>客户端将文件按固定大小（如 1MB/块）切分为多个块。</li><li>分块大小需权衡性能：块越小，断点粒度更细，但元数据开销更大。</li></ul></li><li><strong>生成唯一标识</strong>： <ul><li>计算文件的哈希值（如 MD5 或 SHA1）作为唯一标识，用于服务端校验文件一致性。</li></ul></li><li><strong>查询续传信息</strong>： <ul><li>客户端向服务端发送文件标识，询问已上传的块信息（例如已传第 1-5 块）。</li></ul></li></ol><h4 id="_2-2-传输阶段" tabindex="-1"><strong>2.2 传输阶段</strong> <a class="header-anchor" href="#_2-2-传输阶段" aria-label="Permalink to &quot;**2.2 传输阶段**&quot;">​</a></h4><ol start="4"><li><strong>并行上传分块</strong>： <ul><li>客户端上传未完成的块（如第 6-N 块），可并发多个块提升速度。</li><li>每个块上传时附带以下信息： <ul><li>文件唯一标识（如 MD5）</li><li>当前块序号（如 chunk=6）</li><li>块数据内容</li></ul></li></ul></li><li><strong>服务端校验与存储</strong>： <ul><li>服务端校验块完整性（如计算块哈希值）。</li><li>存储已接收的块，并记录该块已上传（例如在数据库标记 chunk=6 完成）。</li></ul></li></ol><h4 id="_2-3-中断与恢复" tabindex="-1"><strong>2.3 中断与恢复</strong> <a class="header-anchor" href="#_2-3-中断与恢复" aria-label="Permalink to &quot;**2.3 中断与恢复**&quot;">​</a></h4><ol start="6"><li><strong>中断处理</strong>： <ul><li>若网络断开或用户暂停，客户端记录已上传的块信息（如存储到本地 LocalStorage）。</li></ul></li><li><strong>恢复上传</strong>： <ul><li>重新连接后，客户端向服务端查询当前文件的上传进度。</li><li>仅上传未完成的块，跳过已完成的块。</li></ul></li></ol><h4 id="_2-4-合并文件" tabindex="-1"><strong>2.4 合并文件</strong> <a class="header-anchor" href="#_2-4-合并文件" aria-label="Permalink to &quot;**2.4 合并文件**&quot;">​</a></h4><ol start="8"><li><strong>服务端合并分块</strong>： <ul><li>所有块上传完成后，服务端按顺序合并分块，还原完整文件。</li><li>最终校验整体文件的哈希值，确保与客户端一致。</li></ul></li></ol><hr><h3 id="_3-关键技术点" tabindex="-1"><strong>3. 关键技术点</strong> <a class="header-anchor" href="#_3-关键技术点" aria-label="Permalink to &quot;**3. 关键技术点**&quot;">​</a></h3><h4 id="_3-1-分块校验" tabindex="-1"><strong>3.1 分块校验</strong> <a class="header-anchor" href="#_3-1-分块校验" aria-label="Permalink to &quot;**3.1 分块校验**&quot;">​</a></h4><ul><li><strong>块级校验</strong>：每个块上传时附带哈希值（如 MD5），服务端校验通过后才标记为完成。</li><li><strong>整体校验</strong>：合并后计算完整文件的哈希值，防止分块篡改或传输错误。</li></ul><h4 id="_3-2-进度记录" tabindex="-1"><strong>3.2 进度记录</strong> <a class="header-anchor" href="#_3-2-进度记录" aria-label="Permalink to &quot;**3.2 进度记录**&quot;">​</a></h4><ul><li><strong>客户端记录</strong>： <ul><li>本地存储（LocalStorage/IndexedDB）记录已上传的块序号。</li><li>示例：<code>{ fileId: &quot;abc123&quot;, uploadedChunks: [1,2,3,4,5] }</code>。</li></ul></li><li><strong>服务端记录</strong>： <ul><li>数据库存储文件的上传状态（如 Redis 或 MySQL）。</li><li>示例：<code>file_id: abc123, total_chunks: 10, uploaded_chunks: &quot;1,2,3,4,5&quot;</code>。</li></ul></li></ul><h4 id="_3-3-协议支持" tabindex="-1"><strong>3.3 协议支持</strong> <a class="header-anchor" href="#_3-3-协议支持" aria-label="Permalink to &quot;**3.3 协议支持**&quot;">​</a></h4><ul><li><p><strong>HTTP 范围请求（Range Requests）</strong>：</p><ul><li><p>通过 <code>Range</code> 和 <code>Content-Range</code> 头部实现断点下载。</p></li><li><p>示例（下载文件时）：</p><div class="language-http vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /file.mp4 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">HTTP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Range</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes=500-999  // 请求第500-999字节的内容</span></span></code></pre></div></li><li><p>服务端响应：</p><div class="language-http vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">HTTP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 206</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partial Content</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Content-Range</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes 500-999/2000  // 当前块范围/总大小</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Content-Length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 500</span></span></code></pre></div></li></ul></li></ul><hr><h3 id="_4-实际应用案例" tabindex="-1"><strong>4. 实际应用案例</strong> <a class="header-anchor" href="#_4-实际应用案例" aria-label="Permalink to &quot;**4. 实际应用案例**&quot;">​</a></h3><h4 id="_4-1-云存储服务-如百度网盘" tabindex="-1"><strong>4.1 云存储服务（如百度网盘）</strong> <a class="header-anchor" href="#_4-1-云存储服务-如百度网盘" aria-label="Permalink to &quot;**4.1 云存储服务（如百度网盘）**&quot;">​</a></h4><ul><li>大文件上传时自动分块，支持暂停/恢复。</li><li>网络中断后重新连接，自动从断点继续上传。</li></ul><h4 id="_4-2-视频网站-如youtube上传" tabindex="-1"><strong>4.2 视频网站（如YouTube上传）</strong> <a class="header-anchor" href="#_4-2-视频网站-如youtube上传" aria-label="Permalink to &quot;**4.2 视频网站（如YouTube上传）**&quot;">​</a></h4><ul><li>用户上传长视频时，即使关闭浏览器，下次登录可继续上传。</li></ul><h4 id="_4-3-开发工具-如git-lfs" tabindex="-1"><strong>4.3 开发工具（如Git LFS）</strong> <a class="header-anchor" href="#_4-3-开发工具-如git-lfs" aria-label="Permalink to &quot;**4.3 开发工具（如Git LFS）**&quot;">​</a></h4><ul><li>Git 大文件存储支持断点续传，避免因网络问题重复传输。</li></ul><hr><h3 id="_5-代码实现示例-简化的前端上传逻辑" tabindex="-1"><strong>5. 代码实现示例（简化的前端上传逻辑）</strong> <a class="header-anchor" href="#_5-代码实现示例-简化的前端上传逻辑" aria-label="Permalink to &quot;**5. 代码实现示例（简化的前端上传逻辑）**&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 前端：分块上传逻辑</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uploadFile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> CHUNK_SIZE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1MB/块</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> totalChunks</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ceil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(file.size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> CHUNK_SIZE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fileHash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> calculateMD5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(file); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 计算文件哈希</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 查询已上传的块</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uploadedChunks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`/api/status?hash=${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fileHash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> totalChunks; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (uploadedChunks.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 跳过已上传块</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> chunk</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> file.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">slice</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> CHUNK_SIZE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> CHUNK_SIZE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> formData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FormData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    formData.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;hash&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, fileHash);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    formData.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;chunk&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, i);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    formData.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;data&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, chunk);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/api/upload&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { method: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;POST&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, body: formData });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 记录进度（可存储到 LocalStorage）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    saveProgress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fileHash, i);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 服务端：合并分块</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/api/merge&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.body;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  mergeChunks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hash); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 按顺序合并所有块</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  verifyFile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hash);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 校验合并后的文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ success: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><hr><h3 id="_6-优化与注意事项" tabindex="-1"><strong>6. 优化与注意事项</strong> <a class="header-anchor" href="#_6-优化与注意事项" aria-label="Permalink to &quot;**6. 优化与注意事项**&quot;">​</a></h3><ol><li><strong>并发上传</strong>：可同时上传多个块以提升速度（需注意浏览器和服务端并发限制）。</li><li><strong>分块大小选择</strong>： <ul><li>小文件（&lt;100MB）：1MB/块。</li><li>大文件（&gt;1GB）：4MB/块。</li></ul></li><li><strong>防篡改与安全</strong>： <ul><li>服务端需校验客户端提交的块序号和哈希值，防止恶意数据注入。</li></ul></li><li><strong>清理机制</strong>： <ul><li>服务端定期清理未完成上传的临时分块，避免存储浪费。</li></ul></li></ol><hr><h3 id="_7-断点续传-vs-秒传" tabindex="-1"><strong>7. 断点续传 vs 秒传</strong> <a class="header-anchor" href="#_7-断点续传-vs-秒传" aria-label="Permalink to &quot;**7. 断点续传 vs 秒传**&quot;">​</a></h3><table tabindex="0"><thead><tr><th>特性</th><th>断点续传</th><th>秒传</th></tr></thead><tbody><tr><td><strong>核心目标</strong></td><td>解决传输中断问题</td><td>避免重复传输相同文件</td></tr><tr><td><strong>依赖条件</strong></td><td>需要记录传输进度</td><td>依赖文件哈希匹配</td></tr><tr><td><strong>适用场景</strong></td><td>大文件上传/下载</td><td>文件已存在于服务器</td></tr><tr><td><strong>技术实现</strong></td><td>分块传输 + 进度记录</td><td>哈希校验 + 文件去重</td></tr></tbody></table><hr><h3 id="总结-1" tabindex="-1"><strong>总结</strong> <a class="header-anchor" href="#总结-1" aria-label="Permalink to &quot;**总结**&quot;">​</a></h3><p>断点续传通过分块传输和进度记录，有效解决了大文件传输的可靠性问题。其核心在于 <strong>分块、校验、记录、恢复</strong> 四个步骤，结合客户端和服务端的协作，既能提升传输效率，又能避免资源浪费。在实际开发中，需根据业务场景平衡分块大小、并发数和校验粒度，同时注意数据一致性和安全性。</p><h2 id="文件上传的处理过程" tabindex="-1">文件上传的处理过程 <a class="header-anchor" href="#文件上传的处理过程" aria-label="Permalink to &quot;文件上传的处理过程&quot;">​</a></h2><p>文件上传的处理过程涉及客户端（浏览器或应用程序）与服务端的协作，涵盖数据分块、传输协议、验证、存储等多个环节。以下是详细的步骤分解：</p><hr><h3 id="_1-客户端处理阶段" tabindex="-1"><strong>1. 客户端处理阶段</strong> <a class="header-anchor" href="#_1-客户端处理阶段" aria-label="Permalink to &quot;**1. 客户端处理阶段**&quot;">​</a></h3><h4 id="_1-1-用户选择文件" tabindex="-1"><strong>1.1 用户选择文件</strong> <a class="header-anchor" href="#_1-1-用户选择文件" aria-label="Permalink to &quot;**1.1 用户选择文件**&quot;">​</a></h4><ul><li><strong>触发方式</strong>：通过 <code>&lt;input type=&quot;file&quot;&gt;</code> 或拖拽操作选择本地文件。</li><li><strong>获取文件信息</strong>： <ul><li>文件名、大小、类型（MIME）、最后修改时间等元数据。</li><li><strong>前端限制</strong>：可设置 <code>accept</code> 属性限制文件类型（如 <code>accept=&quot;image/*&quot;</code>）。</li></ul></li></ul><h4 id="_1-2-文件预处理" tabindex="-1"><strong>1.2 文件预处理</strong> <a class="header-anchor" href="#_1-2-文件预处理" aria-label="Permalink to &quot;**1.2 文件预处理**&quot;">​</a></h4><ul><li><strong>分块（Chunking）</strong>： <ul><li>大文件（如视频）按固定大小（如 1MB/块）切割为多个小块。</li><li>目的：支持断点续传、提升并发上传效率。</li></ul></li><li><strong>哈希计算</strong>： <ul><li>计算文件整体或分块的哈希值（如 MD5/SHA1），用于服务端秒传校验或完整性验证。</li><li>示例：百度网盘通过文件哈希判断是否已存在相同文件。</li></ul></li><li><strong>编码转换</strong>（可选）： <ul><li>小文件可直接通过 <code>FormData</code> 传输二进制数据。</li><li>特殊场景（如图片预览）可能将文件转为 Base64 字符串。</li></ul></li></ul><h4 id="_1-3-构建请求" tabindex="-1"><strong>1.3 构建请求</strong> <a class="header-anchor" href="#_1-3-构建请求" aria-label="Permalink to &quot;**1.3 构建请求**&quot;">​</a></h4><ul><li><p><strong>使用协议</strong>：</p><ul><li><strong>HTTP POST</strong>：传统表单上传，适合小文件。</li><li><strong>Fetch API / XHR</strong>：支持进度监控和异步处理。</li><li><strong>WebSocket</strong>：实时双向传输，适合大文件或实时协作场景。</li></ul></li><li><p><strong>请求体格式</strong>：</p><ul><li><p><strong>FormData</strong>（多部分表单数据）：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> formData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FormData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">formData.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;file&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, file); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 直接传文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">formData.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;userId&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;123&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li><li><p><strong>Binary</strong>（直接传二进制流）：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/upload&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  method: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;POST&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  body: file, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 直接传文件二进制</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div></li></ul></li></ul><hr><h3 id="_2-网络传输阶段" tabindex="-1"><strong>2. 网络传输阶段</strong> <a class="header-anchor" href="#_2-网络传输阶段" aria-label="Permalink to &quot;**2. 网络传输阶段**&quot;">​</a></h3><h4 id="_2-1-发起上传请求" tabindex="-1"><strong>2.1 发起上传请求</strong> <a class="header-anchor" href="#_2-1-发起上传请求" aria-label="Permalink to &quot;**2.1 发起上传请求**&quot;">​</a></h4><ul><li>客户端将文件数据（或分块）通过 HTTP 发送到服务端接口。</li><li><strong>并发控制</strong>： <ul><li>浏览器对同一域名的并发请求数有限制（HTTP/1.1 默认 6 个）。</li><li>分块上传时，可并行上传多个块以提升速度。</li></ul></li></ul><h4 id="_2-2-传输进度监控" tabindex="-1"><strong>2.2 传输进度监控</strong> <a class="header-anchor" href="#_2-2-传输进度监控" aria-label="Permalink to &quot;**2.2 传输进度监控**&quot;">​</a></h4><ul><li><p><strong>前端监听进度</strong>：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> xhr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> XMLHttpRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">xhr.upload.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;progress&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> percent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (e.loaded </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e.total) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`上传进度：${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">percent</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}%`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">xhr.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">open</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;POST&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/upload&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">xhr.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(formData);</span></span></code></pre></div></li><li><p><strong>优化体验</strong>：展示进度条或取消上传按钮。</p></li></ul><hr><h3 id="_3-服务端处理阶段" tabindex="-1"><strong>3. 服务端处理阶段</strong> <a class="header-anchor" href="#_3-服务端处理阶段" aria-label="Permalink to &quot;**3. 服务端处理阶段**&quot;">​</a></h3><h4 id="_3-1-接收请求" tabindex="-1"><strong>3.1 接收请求</strong> <a class="header-anchor" href="#_3-1-接收请求" aria-label="Permalink to &quot;**3.1 接收请求**&quot;">​</a></h4><ul><li><strong>解析请求体</strong>： <ul><li>使用框架（如 Express 的 <code>multer</code>、Django 的 <code>FileField</code>）处理上传的文件。</li><li>分块上传时，需接收块序号、文件哈希等元数据。</li></ul></li><li><strong>临时存储</strong>： <ul><li>将文件或分块暂存到临时目录（如 <code>/tmp</code>）或内存中。</li></ul></li></ul><h4 id="_3-2-验证与安全处理" tabindex="-1"><strong>3.2 验证与安全处理</strong> <a class="header-anchor" href="#_3-2-验证与安全处理" aria-label="Permalink to &quot;**3.2 验证与安全处理**&quot;">​</a></h4><ul><li><strong>文件类型检查</strong>： <ul><li>通过 MIME 类型或文件扩展名校验（防止上传恶意文件）。</li><li>示例：禁止上传 <code>.exe</code> 或非图片文件。</li></ul></li><li><strong>病毒扫描</strong>（可选）： <ul><li>调用安全服务（如 ClamAV）扫描文件内容。</li></ul></li><li><strong>大小限制</strong>： <ul><li>拒绝超过预设大小的文件（如 Nginx 配置 <code>client_max_body_size</code>）。</li></ul></li></ul><h4 id="_3-3-分块合并-若分块上传" tabindex="-1"><strong>3.3 分块合并（若分块上传）</strong> <a class="header-anchor" href="#_3-3-分块合并-若分块上传" aria-label="Permalink to &quot;**3.3 分块合并（若分块上传）**&quot;">​</a></h4><ul><li>按块序号将分块按顺序合并为完整文件。</li><li>合并后校验整体哈希值，确保与客户端一致。</li></ul><h4 id="_3-4-持久化存储" tabindex="-1"><strong>3.4 持久化存储</strong> <a class="header-anchor" href="#_3-4-持久化存储" aria-label="Permalink to &quot;**3.4 持久化存储**&quot;">​</a></h4><ul><li><strong>存储位置</strong>： <ul><li><strong>本地磁盘</strong>：直接保存到服务器目录（如 <code>/uploads</code>）。</li><li><strong>云存储</strong>：上传到 AWS S3、阿里云 OSS 等对象存储服务。</li><li><strong>数据库</strong>：小文件可存为 BLOB，但通常不推荐（性能差）。</li></ul></li><li><strong>元数据记录</strong>： <ul><li>将文件名、路径、大小、所有者等信息写入数据库。</li></ul></li></ul><h4 id="_3-5-响应客户端" tabindex="-1"><strong>3.5 响应客户端</strong> <a class="header-anchor" href="#_3-5-响应客户端" aria-label="Permalink to &quot;**3.5 响应客户端**&quot;">​</a></h4><ul><li><p>返回上传结果：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://example.com/uploads/file.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;size&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10240</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;hash&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;d41d8cd98f00b204e9800998ecf8427e&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li><li><p>错误处理：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;文件大小超过限制&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li></ul><hr><h3 id="_4-客户端后续处理" tabindex="-1"><strong>4. 客户端后续处理</strong> <a class="header-anchor" href="#_4-客户端后续处理" aria-label="Permalink to &quot;**4. 客户端后续处理**&quot;">​</a></h3><ul><li><strong>完成回调</strong>： <ul><li>更新 UI（如显示“上传成功”）。</li><li>展示文件预览（如图片缩略图、视频封面）。</li></ul></li><li><strong>清理临时数据</strong>： <ul><li>释放内存中的文件对象。</li><li>清除本地存储的断点续传进度（若已成功上传）。</li></ul></li></ul><hr><h3 id="_5-全流程示例-分块上传" tabindex="-1"><strong>5. 全流程示例（分块上传）</strong> <a class="header-anchor" href="#_5-全流程示例-分块上传" aria-label="Permalink to &quot;**5. 全流程示例（分块上传）**&quot;">​</a></h3><ol><li><strong>用户选择 500MB 的视频文件</strong>。</li><li><strong>前端分块</strong>：切成 500 个 1MB 的块，计算文件 MD5 为 <code>abc123</code>。</li><li><strong>查询服务端</strong>：发送 <code>abc123</code> 检查是否存在相同文件。 <ul><li>若存在：触发秒传，直接返回 URL。</li><li>若不存在：开始上传。</li></ul></li><li><strong>上传分块</strong>：并发上传前 6 个块（HTTP/1.1 并发限制）。</li><li><strong>暂停与恢复</strong>：用户暂停后，服务端记录已上传块（1-100）。</li><li><strong>断点续传</strong>：用户重新上传时，仅上传 101-500 块。</li><li><strong>服务端合并分块</strong>，保存到云存储，返回最终 URL。</li></ol><hr><h3 id="_6-常见问题与优化" tabindex="-1"><strong>6. 常见问题与优化</strong> <a class="header-anchor" href="#_6-常见问题与优化" aria-label="Permalink to &quot;**6. 常见问题与优化**&quot;">​</a></h3><h4 id="_6-1-性能优化" tabindex="-1"><strong>6.1 性能优化</strong> <a class="header-anchor" href="#_6-1-性能优化" aria-label="Permalink to &quot;**6.1 性能优化**&quot;">​</a></h4><ul><li><strong>CDN 加速</strong>：通过内容分发网络提升上传/下载速度。</li><li><strong>压缩文件</strong>：前端在上传前压缩图片/视频（如使用 Canvas 压缩图片）。</li><li><strong>懒加载</strong>：非关键文件延迟上传。</li></ul><h4 id="_6-2-安全性" tabindex="-1"><strong>6.2 安全性</strong> <a class="header-anchor" href="#_6-2-安全性" aria-label="Permalink to &quot;**6.2 安全性**&quot;">​</a></h4><ul><li><strong>签名验证</strong>：服务端生成临时上传凭证（如 AWS Pre-signed URL）。</li><li><strong>权限控制</strong>：限制用户上传频率和存储空间配额。</li><li><strong>文件名处理</strong>：避免路径遍历攻击（如过滤 <code>../</code>）。</li></ul><h4 id="_6-3-错误处理" tabindex="-1"><strong>6.3 错误处理</strong> <a class="header-anchor" href="#_6-3-错误处理" aria-label="Permalink to &quot;**6.3 错误处理**&quot;">​</a></h4><ul><li><strong>重试机制</strong>：网络失败时自动重试上传。</li><li><strong>超时设置</strong>：中断长时间未完成的请求。</li><li><strong>日志监控</strong>：记录上传失败原因，便于排查。</li></ul><hr><h3 id="总结-2" tabindex="-1"><strong>总结</strong> <a class="header-anchor" href="#总结-2" aria-label="Permalink to &quot;**总结**&quot;">​</a></h3><p>文件上传的处理过程是一个多阶段协作的流程，涵盖客户端分块、网络传输、服务端验证存储等环节。通过分块、哈希校验和断点续传技术，可显著提升大文件上传的效率和可靠性。实际开发中需结合业务需求，平衡性能、安全性与用户体验。</p><h2 id="self-importscripts-spark-md5-min-js" tabindex="-1">self.importScripts(&#39;./spark.md5.min.js&#39;); <a class="header-anchor" href="#self-importscripts-spark-md5-min-js" aria-label="Permalink to &quot;self.importScripts(&#39;./spark.md5.min.js&#39;);&quot;">​</a></h2><p>在 Web Worker 中，<code>self.importScripts()</code> 是一个关键方法，用于<strong>同步加载并执行外部 JavaScript 脚本</strong>。当你在 Worker 中需要调用第三方库（如 <code>spark-md5</code>）时，必须通过此方法将脚本注入到 Worker 的作用域中。以下是对该方法的详细解析：</p><hr><h3 id="_1-方法定义与用途" tabindex="-1"><strong>1. 方法定义与用途</strong> <a class="header-anchor" href="#_1-方法定义与用途" aria-label="Permalink to &quot;**1. 方法定义与用途**&quot;">​</a></h3><h4 id="语法" tabindex="-1"><strong>语法</strong> <a class="header-anchor" href="#语法" aria-label="Permalink to &quot;**语法**&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">self.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">importScripts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;script1.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;script2.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><ul><li><strong><code>self</code></strong>：Web Worker 的全局对象（等同于 <code>this</code>），可省略直接写 <code>importScripts()</code>。</li><li><strong>参数</strong>：支持多个脚本路径（字符串），按顺序加载并执行。</li></ul><h4 id="核心功能" tabindex="-1"><strong>核心功能</strong> <a class="header-anchor" href="#核心功能" aria-label="Permalink to &quot;**核心功能**&quot;">​</a></h4><ul><li><strong>同步加载</strong>：脚本会立即加载并执行，后续代码需等待加载完成。</li><li><strong>作用域隔离</strong>：加载的脚本在 Worker 线程的全局作用域中运行，与主线程完全隔离。</li><li><strong>依赖管理</strong>：允许在 Worker 中使用外部库（如加密库、数据处理工具等）。</li></ul><hr><h3 id="_2-实际应用场景" tabindex="-1"><strong>2. 实际应用场景</strong> <a class="header-anchor" href="#_2-实际应用场景" aria-label="Permalink to &quot;**2. 实际应用场景**&quot;">​</a></h3><h4 id="示例-在-worker-中计算文件-md5" tabindex="-1"><strong>示例：在 Worker 中计算文件 MD5</strong> <a class="header-anchor" href="#示例-在-worker-中计算文件-md5" aria-label="Permalink to &quot;**示例：在 Worker 中计算文件 MD5**&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// worker.js</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">self.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">importScripts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./spark-md5.min.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 加载 MD5 计算库</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">self.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onmessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> file</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e.data; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 接收文件数据（ArrayBuffer）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> hash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SparkMD5.ArrayBuffer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(file); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 调用库函数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  self.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">postMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ hash }); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 返回结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><h4 id="说明" tabindex="-1"><strong>说明</strong> <a class="header-anchor" href="#说明" aria-label="Permalink to &quot;**说明**&quot;">​</a></h4><ol><li><strong>加载库</strong>：通过 <code>importScripts</code> 引入 <code>spark-md5</code>，使其在 Worker 中可用。</li><li><strong>调用库函数</strong>：加载后，脚本中定义的全局变量（如 <code>SparkMD5</code>）可直接使用。</li><li><strong>数据计算</strong>：在 Worker 中执行耗时操作，避免阻塞主线程。</li></ol><hr><h3 id="_3-关键特性" tabindex="-1"><strong>3. 关键特性</strong> <a class="header-anchor" href="#_3-关键特性" aria-label="Permalink to &quot;**3. 关键特性**&quot;">​</a></h3><h4 id="_3-1-同步执行" tabindex="-1"><strong>3.1 同步执行</strong> <a class="header-anchor" href="#_3-1-同步执行" aria-label="Permalink to &quot;**3.1 同步执行**&quot;">​</a></h4><ul><li><p><strong>阻塞 Worker 线程</strong>：<code>importScripts</code> 是同步方法，加载期间 Worker 会暂停执行。</p></li><li><p><strong>代码顺序性</strong>：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;开始加载脚本&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">importScripts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;a.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;b.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 阻塞直到 a.js 和 b.js 加载完毕</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;脚本加载完成&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li></ul><h4 id="_3-2-路径解析" tabindex="-1"><strong>3.2 路径解析</strong> <a class="header-anchor" href="#_3-2-路径解析" aria-label="Permalink to &quot;**3.2 路径解析**&quot;">​</a></h4><ul><li><p><strong>相对路径</strong>：相对于当前 Worker 脚本的位置（<code>worker.js</code> 的路径）。</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 假设 worker.js 在 /src/ 目录下</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">importScripts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;lib/spark-md5.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 实际路径为 /src/lib/spark-md5.js</span></span></code></pre></div></li><li><p><strong>绝对路径</strong>：支持 URL 或根路径（需注意跨域限制）。</p></li></ul><h4 id="_3-3-全局作用域" tabindex="-1"><strong>3.3 全局作用域</strong> <a class="header-anchor" href="#_3-3-全局作用域" aria-label="Permalink to &quot;**3.3 全局作用域**&quot;">​</a></h4><ul><li><p><strong>变量注入</strong>：加载的脚本中定义的全局变量会合并到 Worker 的全局作用域。</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// lib/math.js</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PI</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3.1415</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 错误！const 不会挂载到全局作用域</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PI</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3.1415</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 正确！var 声明会暴露到全局</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// worker.js</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">importScripts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;lib/math.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 输出 3.1415</span></span></code></pre></div></li></ul><hr><h3 id="_4-常见问题与解决方案" tabindex="-1"><strong>4. 常见问题与解决方案</strong> <a class="header-anchor" href="#_4-常见问题与解决方案" aria-label="Permalink to &quot;**4. 常见问题与解决方案**&quot;">​</a></h3><h4 id="_4-1-路径错误" tabindex="-1"><strong>4.1 路径错误</strong> <a class="header-anchor" href="#_4-1-路径错误" aria-label="Permalink to &quot;**4.1 路径错误**&quot;">​</a></h4><ul><li><strong>现象</strong>：<code>NetworkError: Failed to load worker script</code>。</li><li><strong>解决</strong>： <ul><li>检查脚本路径是否相对于 Worker 文件的位置。</li><li>使用绝对路径（如 <code>https://example.com/lib/spark-md5.js</code>）。</li></ul></li></ul><h4 id="_4-2-跨域限制" tabindex="-1"><strong>4.2 跨域限制</strong> <a class="header-anchor" href="#_4-2-跨域限制" aria-label="Permalink to &quot;**4.2 跨域限制**&quot;">​</a></h4><ul><li><strong>现象</strong>：跨域脚本无法加载（违反同源策略）。</li><li><strong>解决</strong>： <ul><li>服务端设置 <code>CORS</code> 响应头（<code>Access-Control-Allow-Origin: *</code>）。</li><li>将脚本与 Worker 部署在同一域名下。</li></ul></li></ul><h4 id="_4-3-重复加载" tabindex="-1"><strong>4.3 重复加载</strong> <a class="header-anchor" href="#_4-3-重复加载" aria-label="Permalink to &quot;**4.3 重复加载**&quot;">​</a></h4><ul><li><strong>现象</strong>：多次调用 <code>importScripts(&#39;a.js&#39;)</code> 不会重复执行。</li><li><strong>规则</strong>：同一脚本仅加载一次，后续调用会被忽略。</li></ul><h4 id="_4-4-依赖顺序" tabindex="-1"><strong>4.4 依赖顺序</strong> <a class="header-anchor" href="#_4-4-依赖顺序" aria-label="Permalink to &quot;**4.4 依赖顺序**&quot;">​</a></h4><ul><li><p><strong>示例</strong>：若 <code>b.js</code> 依赖 <code>a.js</code>，需先加载 <code>a.js</code>。</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">importScripts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;a.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;b.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 正确顺序</span></span></code></pre></div></li></ul><hr><h3 id="_5-性能优化建议" tabindex="-1"><strong>5. 性能优化建议</strong> <a class="header-anchor" href="#_5-性能优化建议" aria-label="Permalink to &quot;**5. 性能优化建议**&quot;">​</a></h3><ol><li><strong>合并脚本</strong>：将多个小文件合并为单个文件，减少请求次数。</li><li><strong>CDN 加速</strong>：使用 CDN 托管第三方库（如 <code>https://unpkg.com/spark-md5</code>）。</li><li><strong>缓存控制</strong>：服务端设置 <code>Cache-Control</code> 头，避免重复下载。</li></ol><hr><h3 id="_6-对比主线程加载脚本" tabindex="-1"><strong>6. 对比主线程加载脚本</strong> <a class="header-anchor" href="#_6-对比主线程加载脚本" aria-label="Permalink to &quot;**6. 对比主线程加载脚本**&quot;">​</a></h3><table tabindex="0"><thead><tr><th><strong>特性</strong></th><th><strong>主线程（HTML）</strong></th><th><strong>Web Worker</strong></th></tr></thead><tbody><tr><td><strong>加载方式</strong></td><td><code>&lt;script&gt;</code> 标签或动态加载（异步）</td><td><code>importScripts()</code>（同步）</td></tr><tr><td><strong>作用域</strong></td><td>全局作用域</td><td>Worker 全局作用域</td></tr><tr><td><strong>阻塞影响</strong></td><td>可能阻塞渲染</td><td>仅阻塞 Worker 线程</td></tr><tr><td><strong>跨域限制</strong></td><td>遵循 CORS</td><td>同样遵循 CORS</td></tr></tbody></table><hr><h3 id="总结-3" tabindex="-1"><strong>总结</strong> <a class="header-anchor" href="#总结-3" aria-label="Permalink to &quot;**总结**&quot;">​</a></h3><p><code>self.importScripts()</code> 是 Web Worker 中加载外部脚本的核心方法，使得在后台线程中使用第三方库成为可能。使用时需注意：</p><ol><li><strong>同步加载特性</strong>：避免加载过多脚本或大文件，导致 Worker 长时间阻塞。</li><li><strong>路径与跨域</strong>：确保脚本路径正确且符合同源策略。</li><li><strong>依赖管理</strong>：按顺序加载有依赖关系的脚本。</li></ol><h2 id="计算md5值核心代码" tabindex="-1">计算MD5值核心代码 <a class="header-anchor" href="#计算md5值核心代码" aria-label="Permalink to &quot;计算MD5值核心代码&quot;">​</a></h2><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">self.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">importScripts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./spark-md5.min.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">self.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onmessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">chunks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">filename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event.data;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`Received ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chunks</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} chunks for ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">filename</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 初始化 MD5 计算器（针对 ArrayBuffer 优化）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> spark</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> self.SparkMD5.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArrayBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> currentChunk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> loadNext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 创建文件阅读器 Blob 转 ArrayBuffer</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> reader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileReader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 分块读取完成回调</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    reader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(e.target.result);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 将当前分块的 ArrayBuffer 数据注入 MD5 计算流程</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      spark.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(e.target.result);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      currentChunk</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (currentChunk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chunks.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        loadNext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 全部处理完毕，回传最终哈希值和文件名</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        self.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">postMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          filename,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          hash: spark.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 生成最终 MD5</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 读取当前分块为 ArrayBuffer（异步操作）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    reader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">readAsArrayBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(chunks[currentChunk]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 启动处理流程</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  loadNext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>这段代码是一个在 Web Worker 中计算文件 MD5 哈希值的实现。以下是逐步解释：</p><h3 id="_1-引入-sparkmd5-库" tabindex="-1">1. 引入 SparkMD5 库 <a class="header-anchor" href="#_1-引入-sparkmd5-库" aria-label="Permalink to &quot;1. 引入 SparkMD5 库&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">self.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">importScripts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./spark-md5.min.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><ul><li><strong>作用</strong>：在 Web Worker 中加载 SparkMD5 库，该库支持分块计算文件的 MD5 哈希。</li><li><strong>说明</strong>：<code>self</code> 指向 Worker 全局作用域，<code>importScripts</code> 是 Worker 特有的方法，用于同步导入外部脚本。</li></ul><hr><h3 id="_2-监听主线程消息" tabindex="-1">2. 监听主线程消息 <a class="header-anchor" href="#_2-监听主线程消息" aria-label="Permalink to &quot;2. 监听主线程消息&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">self.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onmessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">chunks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">filename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event.data;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`Received ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chunks</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} chunks for ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">filename</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><ul><li><strong>触发条件</strong>：当主线程通过 <code>worker.postMessage()</code> 发送数据时触发。</li><li><strong>参数解析</strong>：<code>event.data</code> 包含主线程传递的 <code>chunks</code>（文件分块数组）和 <code>filename</code>（文件名）。</li></ul><hr><h3 id="_3-初始化-md5-计算器" tabindex="-1">3. 初始化 MD5 计算器 <a class="header-anchor" href="#_3-初始化-md5-计算器" aria-label="Permalink to &quot;3. 初始化 MD5 计算器&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> spark</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> self.SparkMD5.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ArrayBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> currentChunk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><ul><li><strong><code>spark</code> 对象</strong>：使用 <code>SparkMD5.ArrayBuffer()</code> 初始化一个针对二进制数据优化的 MD5 计算实例。</li><li><strong><code>currentChunk</code></strong>：跟踪当前处理的分块索引（从 0 开始）。</li></ul><hr><h3 id="_4-分块处理函数-loadnext" tabindex="-1">4. 分块处理函数 <code>loadNext</code> <a class="header-anchor" href="#_4-分块处理函数-loadnext" aria-label="Permalink to &quot;4. 分块处理函数 `loadNext`&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> loadNext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> reader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FileReader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><ul><li><strong>创建 <code>FileReader</code></strong>：用于将文件分块读取为 <code>ArrayBuffer</code>。</li></ul><hr><h3 id="_5-定义读取完成回调" tabindex="-1">5. 定义读取完成回调 <a class="header-anchor" href="#_5-定义读取完成回调" aria-label="Permalink to &quot;5. 定义读取完成回调&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">reader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(e.target.result);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  spark.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(e.target.result);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  currentChunk</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><ul><li><strong>读取完成</strong>：<code>e.target.result</code> 是当前分块的 <code>ArrayBuffer</code> 数据。</li><li><strong>更新哈希状态</strong>：<code>spark.append()</code> 将当前分块数据追加到 MD5 计算流程中。</li><li><strong>递增索引</strong>：<code>currentChunk++</code> 准备处理下一个分块。</li></ul><hr><h3 id="_6-递归处理或返回结果" tabindex="-1">6. 递归处理或返回结果 <a class="header-anchor" href="#_6-递归处理或返回结果" aria-label="Permalink to &quot;6. 递归处理或返回结果&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (currentChunk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chunks.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    loadNext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    self.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">postMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      filename,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      hash: spark.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><ul><li><strong>递归处理</strong>：如果还有未处理的分块，递归调用 <code>loadNext()</code>。</li><li><strong>完成计算</strong>：所有分块处理完毕后，<code>spark.end()</code> 生成最终 MD5 哈希，通过 <code>postMessage</code> 回传主线程。</li></ul><hr><h3 id="_7-启动分块读取" tabindex="-1">7. 启动分块读取 <a class="header-anchor" href="#_7-启动分块读取" aria-label="Permalink to &quot;7. 启动分块读取&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">reader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">readAsArrayBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(chunks[currentChunk]);</span></span></code></pre></div><ul><li><strong>异步读取</strong>：将当前分块转换为 <code>ArrayBuffer</code>，触发 <code>onload</code> 回调。</li></ul><hr><h3 id="_8-启动处理流程" tabindex="-1">8. 启动处理流程 <a class="header-anchor" href="#_8-启动处理流程" aria-label="Permalink to &quot;8. 启动处理流程&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">loadNext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><ul><li><strong>启动递归</strong>：开始处理第一个分块，链式触发后续分块处理。</li></ul><hr><h3 id="关键机制总结" tabindex="-1">关键机制总结 <a class="header-anchor" href="#关键机制总结" aria-label="Permalink to &quot;关键机制总结&quot;">​</a></h3><ul><li><strong>分块顺序</strong>：通过递归确保分块按顺序处理，MD5 计算依赖数据顺序。</li><li><strong>异步非阻塞</strong>：<code>FileReader</code> 异步读取避免阻塞 Worker 线程。</li><li><strong>内存优化</strong>：逐块处理避免一次性加载大文件，适合处理超大文件。</li><li><strong>哈希累积计算</strong>：<code>spark.append()</code> 逐步更新哈希状态，<code>spark.end()</code> 生成最终结果。</li></ul><h3 id="潜在改进点" tabindex="-1">潜在改进点 <a class="header-anchor" href="#潜在改进点" aria-label="Permalink to &quot;潜在改进点&quot;">​</a></h3><ul><li><strong>错误处理</strong>：添加 <code>reader.onerror</code> 回调处理读取失败。</li><li><strong>进度反馈</strong>：在 <code>currentChunk++</code> 后发送进度信息给主线程。</li><li><strong>终止逻辑</strong>：支持主线程发送中止信号，终止计算。</li></ul><p>此代码实现了高效的大文件 MD5 计算，适用于文件上传前的哈希校验、秒传等场景。</p><h2 id="multer" tabindex="-1">Multer <a class="header-anchor" href="#multer" aria-label="Permalink to &quot;Multer&quot;">​</a></h2><p>Multer 是 Node.js 中用于处理 <code>multipart/form-data</code> 类型表单数据的中间件，常用于文件上传。以下是其核心功能及使用方法的详细说明：</p><hr><h3 id="一、核心概念" tabindex="-1"><strong>一、核心概念</strong> <a class="header-anchor" href="#一、核心概念" aria-label="Permalink to &quot;**一、核心概念**&quot;">​</a></h3><ol><li><p><strong>适用场景</strong></p><ul><li>处理表单中通过 <code>&lt;input type=&quot;file&quot;&gt;</code> 上传的文件。</li><li>解析 <code>enctype=&quot;multipart/form-data&quot;</code> 的请求。</li></ul></li><li><p><strong>基础特性</strong></p><ul><li><strong>内存存储</strong>：文件暂存于内存（适合小文件或需进一步处理到云存储的场景）。</li><li><strong>磁盘存储</strong>：文件保存到本地目录（适合直接持久化存储）。</li></ul></li></ol><hr><h3 id="二、安装与基础配置" tabindex="-1"><strong>二、安装与基础配置</strong> <a class="header-anchor" href="#二、安装与基础配置" aria-label="Permalink to &quot;**二、安装与基础配置**&quot;">​</a></h3><ol><li><p><strong>安装</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> multer</span></span></code></pre></div></li><li><p><strong>基础代码示例</strong></p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> express</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;express&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> multer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;multer&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> app</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> express</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 存储配置</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> storage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> multer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">diskStorage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  destination</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;uploads/&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 保存至 uploads 目录</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  filename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;-&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> file.originalname); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 文件名添加时间戳防重复</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> upload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> multer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ storage });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/upload&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, upload.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">single</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;file&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req.file); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 上传成功后的文件信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;File uploaded&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">listen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li></ol><hr><h3 id="三、配置详解" tabindex="-1"><strong>三、配置详解</strong> <a class="header-anchor" href="#三、配置详解" aria-label="Permalink to &quot;**三、配置详解**&quot;">​</a></h3><ol><li><p><strong>存储引擎（Storage）</strong></p><ul><li><p><strong>DiskStorage</strong></p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">multer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">diskStorage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  destination</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./uploads&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 指定路径（需确保目录存在）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  filename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 定制文件名（避免重名+安全过滤）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sanitizedName</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> file.originalname.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">^</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\w.-]</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">g</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Date</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">()</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}-${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sanitizedName</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div></li><li><p><strong>MemoryStorage</strong></p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> storage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> multer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">memoryStorage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> upload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> multer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ storage });</span></span></code></pre></div></li></ul></li><li><p><strong>过滤文件（File Filter）</strong><br> 验证文件类型或拒绝指定文件：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> upload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> multer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  storage,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  fileFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> allowedTypes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;image/jpeg&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;image/png&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (allowedTypes.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(file.mimetype)) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 接受文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;仅支持 JPG/PNG 格式&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 拒绝文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div></li><li><p><strong>限制文件大小</strong></p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> upload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> multer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  storage,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  limits: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fileSize: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 最大 5MB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    files: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   // 最多 3 个文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div></li></ol><hr><h3 id="四、不同上传方式的处理" tabindex="-1"><strong>四、不同上传方式的处理</strong> <a class="header-anchor" href="#四、不同上传方式的处理" aria-label="Permalink to &quot;**四、不同上传方式的处理**&quot;">​</a></h3><table tabindex="0"><thead><tr><th>方法</th><th>适用场景</th><th>文件访问路径</th></tr></thead><tbody><tr><td><code>.single(&#39;field&#39;)</code></td><td>单个文件上传</td><td><code>req.file</code></td></tr><tr><td><code>.array(&#39;field&#39;, max)</code></td><td>多个同名文件上传</td><td><code>req.files</code></td></tr><tr><td><code>.fields([{ name: &#39;field&#39;, max: 1 }, ...])</code></td><td>多字段不同文件上传</td><td><code>req.files</code></td></tr><tr><td><code>.none()</code></td><td>处理无文件字段的文本表单</td><td><code>req.body</code></td></tr></tbody></table><p><strong>示例：多文件上传</strong></p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/upload-multi&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, upload.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;photos&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  req.files.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`文件 ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">originalname</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} 已保存至 ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">path</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;多个文件上传成功&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><hr><h3 id="五、错误处理" tabindex="-1"><strong>五、错误处理</strong> <a class="header-anchor" href="#五、错误处理" aria-label="Permalink to &quot;**五、错误处理**&quot;">​</a></h3><ol><li><p><strong>捕获 Multer 错误</strong></p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/upload&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, upload.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">single</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;file&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 处理文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> multer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MulterError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">400</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`文件上传错误: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">err</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">message</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;服务器错误&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div></li><li><p><strong>常见错误类型</strong></p><ul><li><code>LIMIT_FILE_SIZE</code>：文件超过大小限制。</li><li><code>LIMIT_FILE_COUNT</code>：文件数量超过限制。</li><li><code>LIMIT_UNEXPECTED_FILE</code>：字段匹配错误。</li></ul></li></ol><hr><h3 id="六、安全与最佳实践" tabindex="-1"><strong>六、安全与最佳实践</strong> <a class="header-anchor" href="#六、安全与最佳实践" aria-label="Permalink to &quot;**六、安全与最佳实践**&quot;">​</a></h3><ol><li><p><strong>安全措施</strong></p><ul><li><p><strong>检查文件类型</strong>：拒绝执行文件（如 <code>.exe</code>、<code>.php</code>）。</p></li><li><p><strong>设置文件扩展名</strong>：直接从 MIME 类型推断扩展名（防止篡改）。</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getExt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mimeType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> extMap</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;image/jpeg&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.jpg&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;image/png&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.png&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> extMap[mimeType] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;.tmp&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getExt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(file.mimetype));</span></span></code></pre></div></li><li><p><strong>控制上传目录权限</strong>：避免目录遍历攻击。</p></li></ul></li><li><p><strong>云存储集成示例（AWS S3）</strong></p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> aws</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;aws-sdk&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> multerS3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;multer-s3&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> s3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> aws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">S3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ region: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;us-east-1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> upload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> multer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  storage: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">multerS3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    s3,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    bucket: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;my-bucket&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    contentType: multerS3.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AUTO_CONTENT_TYPE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`uploads/${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Date</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">()</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}-${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">originalname</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div></li></ol><hr><h3 id="七、实际应用场景" tabindex="-1"><strong>七、实际应用场景</strong> <a class="header-anchor" href="#七、实际应用场景" aria-label="Permalink to &quot;**七、实际应用场景**&quot;">​</a></h3><ul><li><strong>用户头像上传</strong>：通过裁剪工具处理后保存到 CDN。</li><li><strong>批量导入数据</strong>：上传 CSV/Excel 文件解析后存入数据库。</li><li><strong>图片/视频托管</strong>：结合云存储生成安全访问链接。</li></ul><hr><p>通过合理配置 Multer，开发者能够高效、安全地实现文件上传逻辑，避免常见的安全漏洞和性能瓶颈。建议结合具体场景选择存储策略，并始终对用户上传内容进行严格校验。</p><h2 id="multer配置实例" tabindex="-1">multer配置实例 <a class="header-anchor" href="#multer配置实例" aria-label="Permalink to &quot;multer配置实例&quot;">​</a></h2><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> storage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> multer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">diskStorage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  destination</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req.body)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdirSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`uploads/${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">req</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">body</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">hash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { recursive: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ?</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`uploads/${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">req</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">body</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">hash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}/`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  filename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">req</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">body</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">filename</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}-${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">req</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">body</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">index</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><h3 id="_1-recursive-true-的作用" tabindex="-1"><strong>1. <code>recursive: true</code> 的作用</strong> <a class="header-anchor" href="#_1-recursive-true-的作用" aria-label="Permalink to &quot;**1. `recursive: true` 的作用**&quot;">​</a></h3><p>在 <code>fs.mkdirSync</code> 方法中，<code>recursive: true</code> 表示 <strong>递归创建目录</strong>。如果目标路径中的父级目录不存在，它会自动创建所有必需的中间目录。</p><h4 id="示例" tabindex="-1"><strong>示例</strong>： <a class="header-anchor" href="#示例" aria-label="Permalink to &quot;**示例**：&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdirSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;uploads/a/b/c&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { recursive: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span></code></pre></div><ul><li><strong>效果</strong>：<br> 如果 <code>uploads</code> 目录不存在，会依次创建：<br><code>uploads</code> → <code>uploads/a</code> → <code>uploads/a/b</code> → <code>uploads/a/b/c</code></li><li><strong>若不设置 <code>recursive: true</code></strong>：<br> 当父目录（如 <code>uploads/a</code>）不存在时，直接报错 <code>ENOENT</code>。</li></ul><hr><h3 id="_2-cb-null-uploads-req-body-hash-的含义" tabindex="-1"><strong>2. <code>cb(null, &#39;uploads/${req.body.hash}/&#39;)</code> 的含义</strong> <a class="header-anchor" href="#_2-cb-null-uploads-req-body-hash-的含义" aria-label="Permalink to &quot;**2. `cb(null, &#39;uploads/${req.body.hash}/&#39;)` 的含义**&quot;">​</a></h3><p>这是 Multer 的回调函数，用于 <strong>通知 Multer 文件存储的目标路径</strong>。</p><h4 id="参数解析" tabindex="-1"><strong>参数解析</strong>： <a class="header-anchor" href="#参数解析" aria-label="Permalink to &quot;**参数解析**：&quot;">​</a></h4><ul><li><p><strong>第一个参数 <code>null</code></strong>：<br> 表示没有错误发生。如果出现错误（如权限不足），应传递 <code>Error</code> 对象，例如：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;创建目录失败&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span></code></pre></div></li><li><p><strong>第二个参数 <code>&#39;uploads/${req.body.hash}/&#39;</code></strong>：<br> 指定文件存储的目标目录。这里的路径基于客户端上传时传递的 <code>req.body.hash</code> 动态生成。</p></li></ul><hr><h3 id="_3-代码整体逻辑解析" tabindex="-1"><strong>3. 代码整体逻辑解析</strong> <a class="header-anchor" href="#_3-代码整体逻辑解析" aria-label="Permalink to &quot;**3. 代码整体逻辑解析**&quot;">​</a></h3><h4 id="_1-destination-函数" tabindex="-1"><strong>(1) <code>destination</code> 函数</strong> <a class="header-anchor" href="#_1-destination-函数" aria-label="Permalink to &quot;**(1) `destination` 函数**&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">destination</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 1. 同步创建目录（包含父目录）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdirSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`uploads/${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">req</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">body</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">hash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { recursive: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 2. 通知 Multer 文件存储路径</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`uploads/${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">req</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">body</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">hash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}/`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><strong>步骤</strong>： <ol><li><strong>创建目录</strong>：确保 <code>uploads/${req.body.hash}</code> 存在。</li><li><strong>设置存储路径</strong>：将文件保存到该目录下。</li></ol></li></ul><h4 id="_2-filename-函数" tabindex="-1"><strong>(2) <code>filename</code> 函数</strong> <a class="header-anchor" href="#_2-filename-函数" aria-label="Permalink to &quot;**(2) `filename` 函数**&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 生成文件名：客户端传递的 filename 和 index 拼接</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">req</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">body</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">filename</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}-${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">req</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">body</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">index</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><strong>文件名格式</strong>：<code>filename-0</code>, <code>filename-1</code> 等，用于分块上传后合并文件。</li></ul><hr><h3 id="_4-关键注意事项" tabindex="-1"><strong>4. 关键注意事项</strong> <a class="header-anchor" href="#_4-关键注意事项" aria-label="Permalink to &quot;**4. 关键注意事项**&quot;">​</a></h3><h4 id="_1-req-body-的数据来源" tabindex="-1"><strong>(1) <code>req.body</code> 的数据来源</strong> <a class="header-anchor" href="#_1-req-body-的数据来源" aria-label="Permalink to &quot;**(1) `req.body` 的数据来源**&quot;">​</a></h4><ul><li><p><strong>客户端需上传额外字段</strong>：<br> 客户端必须在请求体中包含 <code>hash</code>、<code>filename</code> 和 <code>index</code> 字段（通常通过表单或 JSON 传递）。<br><strong>示例请求体</strong>：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;hash&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;d41d8cd98f00b204e9800998ecf8427e&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;filename&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;video.mp4&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;index&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li><li><p><strong>服务端需配置解析中间件</strong>：<br> 确保 Express 能解析请求体，需添加：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(express.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 解析 JSON 格式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(express.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">urlencoded</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ extended: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> })); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 解析表单格式</span></span></code></pre></div></li></ul><h4 id="_2-同步-vs-异步" tabindex="-1"><strong>(2) 同步 vs 异步</strong> <a class="header-anchor" href="#_2-同步-vs-异步" aria-label="Permalink to &quot;**(2) 同步 vs 异步**&quot;">​</a></h4><ul><li><p><strong><code>fs.mkdirSync</code> 是同步操作</strong>：<br> 会阻塞事件循环，但在此场景中影响较小（目录创建通常极快）。</p></li><li><p><strong>生产环境改进</strong>：<br> 可改用异步方法 <code>fs.promises.mkdir</code> 避免阻塞：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.promises.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`uploads/${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">req</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">body</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">hash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { recursive: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`uploads/${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">req</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">body</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">hash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}/`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li></ul><hr><h3 id="_5-完整流程示例" tabindex="-1"><strong>5. 完整流程示例</strong> <a class="header-anchor" href="#_5-完整流程示例" aria-label="Permalink to &quot;**5. 完整流程示例**&quot;">​</a></h3><ol><li><strong>客户端上传分块</strong>： <ul><li>发送文件分块，并在请求体中包含 <code>hash</code>（文件唯一标识）、<code>filename</code>（文件名）、<code>index</code>（分块序号）。</li></ul></li><li><strong>服务端存储分块</strong>： <ul><li>根据 <code>hash</code> 创建目录（如 <code>uploads/d41d8cd98f00b204e9800998ecf8427e</code>）。</li><li>将分块保存为 <code>filename-0</code>, <code>filename-1</code> 等文件。</li></ul></li><li><strong>合并分块</strong>： <ul><li>客户端通知服务端合并时，服务端按 <code>index</code> 顺序读取所有分块，合并成完整文件。</li></ul></li></ol><hr><h3 id="总结-4" tabindex="-1"><strong>总结</strong> <a class="header-anchor" href="#总结-4" aria-label="Permalink to &quot;**总结**&quot;">​</a></h3><ul><li><strong><code>recursive: true</code></strong>：确保目录层级自动创建，避免路径不存在导致的错误。</li><li><strong><code>cb(null, path)</code></strong>：通过回调函数动态设置存储路径和文件名，灵活适配分块上传需求。</li><li><strong>适用场景</strong>：大文件分块上传、断点续传、分布式存储等需要动态目录管理的场景。</li></ul><h2 id="formdata" tabindex="-1">FormData <a class="header-anchor" href="#formdata" aria-label="Permalink to &quot;FormData&quot;">​</a></h2><p>在 JavaScript 中，<code>FormData</code> 是一个用于构造 <strong>表单数据（form-data）</strong> 的 Web API 对象，专门用来处理 <code>multipart/form-data</code> 类型的 HTTP 请求（常见于文件上传场景）。在你的代码中，它用于将文件分块（<code>chunk</code>）和其他元数据一起发送到服务端。</p><hr><h3 id="formdata-的作用详解" tabindex="-1"><strong>FormData 的作用详解</strong> <a class="header-anchor" href="#formdata-的作用详解" aria-label="Permalink to &quot;**FormData 的作用详解**&quot;">​</a></h3><h4 id="_1-数据结构" tabindex="-1"><strong>1. 数据结构</strong> <a class="header-anchor" href="#_1-数据结构" aria-label="Permalink to &quot;**1. 数据结构**&quot;">​</a></h4><ul><li><strong>键值对存储</strong>：通过 <code>append</code> 方法添加字段，每个字段由 <code>name</code> 和 <code>value</code> 组成。</li><li><strong>支持多种数据类型</strong>：可附加字符串、Blob（如文件）、File 对象等。</li></ul><h4 id="_2-在你的代码中的用途" tabindex="-1"><strong>2. 在你的代码中的用途</strong> <a class="header-anchor" href="#_2-在你的代码中的用途" aria-label="Permalink to &quot;**2. 在你的代码中的用途**&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> formData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FormData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">formData.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;filename&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, filename);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 文件名（如 example.txt）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">formData.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;hash&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, hash);          </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 文件哈希（用于校验完整性）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">formData.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;index&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, index);        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 分块序号（如第 3 块）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">formData.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, chunk);          </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 文件分块数据（二进制内容）</span></span></code></pre></div><ul><li><p><strong>服务端接收示例</strong>：<br> 在 Node.js（使用 Express + Multer）中，可通过以下方式获取：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 上传接口</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/upload&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, upload.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">single</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">filename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.body; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 非文件字段</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fileChunk</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.file;                 </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 文件字段（对应 formData.append(&quot;file&quot;, chunk)）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div></li></ul><h4 id="_3-为什么用-formdata" tabindex="-1"><strong>3. 为什么用 FormData？</strong> <a class="header-anchor" href="#_3-为什么用-formdata" aria-label="Permalink to &quot;**3. 为什么用 FormData？**&quot;">​</a></h4><ul><li><strong>原生支持文件传输</strong>：浏览器会自动将 <code>FormData</code> 转换为 <code>multipart/form-data</code> 格式，适合传输二进制文件。</li><li><strong>兼容分块上传</strong>：每个分块独立发送时，附带元数据（如 <code>hash</code>、<code>index</code>），服务端可据此重组文件。</li></ul><hr><h3 id="formdata-的底层行为" tabindex="-1"><strong>FormData 的底层行为</strong> <a class="header-anchor" href="#formdata-的底层行为" aria-label="Permalink to &quot;**FormData 的底层行为**&quot;">​</a></h3><h4 id="_1-http-请求头" tabindex="-1"><strong>1. HTTP 请求头</strong> <a class="header-anchor" href="#_1-http-请求头" aria-label="Permalink to &quot;**1. HTTP 请求头**&quot;">​</a></h4><p>当使用 <code>FormData</code> 时，浏览器会自动设置请求头：</p><div class="language-http vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Content-Type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> multipart/form-data; boundary=----WebKitFormBoundaryABC123</span></span></code></pre></div><ul><li><strong>boundary</strong>：分隔符，用于划分不同字段的边界。</li></ul><h4 id="_2-请求体格式" tabindex="-1"><strong>2. 请求体格式</strong> <a class="header-anchor" href="#_2-请求体格式" aria-label="Permalink to &quot;**2. 请求体格式**&quot;">​</a></h4><p>发送的请求体内容大致如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>------WebKitFormBoundaryABC123</span></span>
<span class="line"><span>Content-Disposition: form-data; name=&quot;filename&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>example.txt</span></span>
<span class="line"><span>------WebKitFormBoundaryABC123</span></span>
<span class="line"><span>Content-Disposition: form-data; name=&quot;hash&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>a1b2c3d4</span></span>
<span class="line"><span>------WebKitFormBoundaryABC123</span></span>
<span class="line"><span>Content-Disposition: form-data; name=&quot;index&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3</span></span>
<span class="line"><span>------WebKitFormBoundaryABC123</span></span>
<span class="line"><span>Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;chunk-3&quot;</span></span>
<span class="line"><span>Content-Type: application/octet-stream</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&lt;二进制文件内容&gt;</span></span>
<span class="line"><span>------WebKitFormBoundaryABC123--</span></span></code></pre></div><hr><h3 id="注意事项" tabindex="-1"><strong>注意事项</strong> <a class="header-anchor" href="#注意事项" aria-label="Permalink to &quot;**注意事项**&quot;">​</a></h3><ol><li><p><strong>字段顺序无关</strong>：服务端通过字段名（如 <code>filename</code>、<code>file</code>）解析数据，与 <code>append</code> 顺序无关。</p></li><li><p><strong>文件字段建议放在最后</strong>：某些服务端框架（如 Multer）要求文件字段是最后一个字段，否则可能解析失败。</p></li><li><p><strong>Blob/File 对象的处理</strong>：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">formData.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, chunk, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;chunk-3.dat&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 第三个参数为文件名（可选）</span></span></code></pre></div></li></ol><hr><h3 id="替代方案" tabindex="-1"><strong>替代方案</strong> <a class="header-anchor" href="#替代方案" aria-label="Permalink to &quot;**替代方案**&quot;">​</a></h3><ul><li><strong>Base64 编码</strong>：将文件转为字符串通过 JSON 发送，但体积膨胀约 33%，效率低。</li><li><strong>二进制流</strong>：直接发送 <code>Blob</code>，但无法附带元数据，需通过 URL 参数或自定义 Header 传递。</li></ul><hr><p>通过 <code>FormData</code>，你可以高效、规范地实现文件分块上传，是 Web 开发中处理文件传输的标准方案。</p><h2 id="dirname" tabindex="-1">__dirname <a class="header-anchor" href="#dirname" aria-label="Permalink to &quot;__dirname&quot;">​</a></h2><p>在 Node.js 中，<strong><code>__dirname</code> 是一个全局变量</strong>，表示 <strong>当前执行脚本所在的目录的绝对路径</strong>。它是 Node.js 模块系统自动注入的变量，无需额外定义即可直接使用。以下是详细解释：</p><hr><h3 id="_1-dirname-的核心特性" tabindex="-1"><strong>1. <code>__dirname</code> 的核心特性</strong> <a class="header-anchor" href="#_1-dirname-的核心特性" aria-label="Permalink to &quot;**1. `__dirname` 的核心特性**&quot;">​</a></h3><ul><li><p><strong>类型</strong>：字符串（绝对路径）。</p></li><li><p><strong>作用</strong>：始终指向当前 <code>.js</code> 文件所在的目录。</p></li><li><p><strong>示例</strong>：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 文件路径：/home/user/project/app.js</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(__dirname);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 输出：/home/user/project</span></span></code></pre></div></li></ul><hr><h3 id="_2-常见使用场景" tabindex="-1"><strong>2. 常见使用场景</strong> <a class="header-anchor" href="#_2-常见使用场景" aria-label="Permalink to &quot;**2. 常见使用场景**&quot;">​</a></h3><h4 id="_1-路径拼接" tabindex="-1"><strong>(1) 路径拼接</strong> <a class="header-anchor" href="#_1-路径拼接" aria-label="Permalink to &quot;**(1) 路径拼接**&quot;">​</a></h4><p>避免硬编码路径，动态生成文件路径：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;fs&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;path&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 读取当前目录下的 config.json</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> configPath</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> path.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(__dirname, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;config.json&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> config</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">readFileSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(configPath, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utf-8&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h4 id="_2-静态资源目录" tabindex="-1"><strong>(2) 静态资源目录</strong> <a class="header-anchor" href="#_2-静态资源目录" aria-label="Permalink to &quot;**(2) 静态资源目录**&quot;">​</a></h4><p>在 Express 中设置静态资源目录：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> express</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;express&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> app</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> express</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 指定静态资源目录为当前目录下的 public 文件夹</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(express.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(path.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(__dirname, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;public&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)));</span></span></code></pre></div><hr><h3 id="_3-dirname-与其他路径变量的区别" tabindex="-1"><strong>3. <code>__dirname</code> 与其他路径变量的区别</strong> <a class="header-anchor" href="#_3-dirname-与其他路径变量的区别" aria-label="Permalink to &quot;**3. `__dirname` 与其他路径变量的区别**&quot;">​</a></h3><table tabindex="0"><thead><tr><th><strong>变量/方法</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><code>__dirname</code></td><td>当前文件所在目录的绝对路径（不包含文件名）。</td></tr><tr><td><code>__filename</code></td><td>当前文件的绝对路径（包含文件名）。</td></tr><tr><td><code>process.cwd()</code></td><td><strong>执行 Node 命令时的当前工作目录</strong>（可能与 <code>__dirname</code> 不同）。</td></tr></tbody></table><h4 id="示例对比" tabindex="-1"><strong>示例对比</strong> <a class="header-anchor" href="#示例对比" aria-label="Permalink to &quot;**示例对比**&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 文件路径：/home/user/project/app.js</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(__dirname);    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// /home/user/project</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(__filename);   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// /home/user/project/app.js</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(process.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cwd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 可能是 /home/user（取决于启动命令的目录）</span></span></code></pre></div><hr><h3 id="_4-为什么推荐使用-path-join-拼接路径" tabindex="-1"><strong>4. 为什么推荐使用 <code>path.join()</code> 拼接路径？</strong> <a class="header-anchor" href="#_4-为什么推荐使用-path-join-拼接路径" aria-label="Permalink to &quot;**4. 为什么推荐使用 `path.join()` 拼接路径？**&quot;">​</a></h3><ul><li><p><strong>跨平台兼容性</strong>：<code>path.join()</code> 自动处理不同操作系统的路径分隔符（如 Windows 的 <code>\</code> 和 Linux/macOS 的 <code>/</code>）。</p></li><li><p><strong>避免错误</strong>：手动拼接路径容易遗漏斜杠或重复斜杠，例如：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 错误写法（可能产生双斜杠）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> badPath</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> __dirname </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;/subdir/file.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 正确写法</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> goodPath</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> path.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(__dirname, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;subdir&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;file.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li></ul><hr><h3 id="_5-在-es-模块中使用-dirname" tabindex="-1"><strong>5. 在 ES 模块中使用 <code>__dirname</code></strong> <a class="header-anchor" href="#_5-在-es-模块中使用-dirname" aria-label="Permalink to &quot;**5. 在 ES 模块中使用 `__dirname`**&quot;">​</a></h3><p>在 Node.js 的 <strong>ES 模块</strong>（使用 <code>import/export</code>）中，<code>__dirname</code> 默认不可用。需通过以下方式获取：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { fileURLToPath } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;url&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { dirname } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;path&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __filename</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fileURLToPath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">meta</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.url);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __dirname</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> dirname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(__filename);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(__dirname); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 等效于 CommonJS 的 __dirname</span></span></code></pre></div><hr><h3 id="_6-常见问题" tabindex="-1"><strong>6. 常见问题</strong> <a class="header-anchor" href="#_6-常见问题" aria-label="Permalink to &quot;**6. 常见问题**&quot;">​</a></h3><h4 id="_1-为什么-process-cwd-和-dirname-不同" tabindex="-1"><strong>(1) 为什么 <code>process.cwd()</code> 和 <code>__dirname</code> 不同？</strong> <a class="header-anchor" href="#_1-为什么-process-cwd-和-dirname-不同" aria-label="Permalink to &quot;**(1) 为什么 `process.cwd()` 和 `__dirname` 不同？**&quot;">​</a></h4><ul><li><code>process.cwd()</code> 是 <strong>启动 Node 进程时的当前目录</strong>。</li><li><code>__dirname</code> 是 <strong>当前执行脚本所在的目录</strong>。</li></ul><p><strong>示例</strong>：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 在 /home/user 目录下执行命令</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /home/user/project/app.js</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 此时：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">process.cwd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() → /home/user</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__dirname</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> →</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /home/user/project</span></span></code></pre></div><h4 id="_2-调试路径问题" tabindex="-1"><strong>(2) 调试路径问题</strong> <a class="header-anchor" href="#_2-调试路径问题" aria-label="Permalink to &quot;**(2) 调试路径问题**&quot;">​</a></h4><p>如果路径不符合预期，可通过以下代码检查：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;__dirname:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, __dirname);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Target Path:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, path.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(__dirname, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;subdir/file.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span></code></pre></div><hr><h3 id="总结-5" tabindex="-1"><strong>总结</strong> <a class="header-anchor" href="#总结-5" aria-label="Permalink to &quot;**总结**&quot;">​</a></h3><ul><li><strong><code>__dirname</code></strong> 是 Node.js 中处理文件路径的基石，用于动态定位文件。</li><li>始终使用 <code>path.join(__dirname, ...)</code> 拼接路径，确保跨平台兼容性。</li><li>在 ES 模块中需通过 <code>import.meta.url</code> 转换获取等效的 <code>__dirname</code>。</li></ul><h2 id="fs-createwritestream" tabindex="-1">fs.createWriteStream <a class="header-anchor" href="#fs-createwritestream" aria-label="Permalink to &quot;fs.createWriteStream&quot;">​</a></h2><p>在 Node.js 中，<code>fs.createWriteStream</code> 是一个用于创建可写流的方法，允许高效地将数据逐步写入文件。以下是详细的分步解释：</p><hr><h3 id="_1-方法定义" tabindex="-1"><strong>1. 方法定义</strong> <a class="header-anchor" href="#_1-方法定义" aria-label="Permalink to &quot;**1. 方法定义**&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;fs&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> writeStream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createWriteStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(path[, options]);</span></span></code></pre></div><ul><li><strong>参数</strong>： <ul><li><code>path</code> (字符串): 要写入的文件路径。</li><li><code>options</code> (对象，可选): 配置选项，常用属性： <ul><li><code>flags</code>: 文件操作标志，默认为 <code>&#39;w&#39;</code>（写入并覆盖）。</li><li><code>encoding</code>: 编码格式，默认为 <code>&#39;utf8&#39;</code>。</li><li><code>mode</code>: 文件权限，默认为 <code>0o666</code>（可读写）。</li><li><code>autoClose</code>: 是否自动关闭流，默认为 <code>true</code>。</li><li><code>start</code>: 写入的起始位置（字节）。</li></ul></li></ul></li></ul><hr><h3 id="_2-创建可写流" tabindex="-1"><strong>2. 创建可写流</strong> <a class="header-anchor" href="#_2-创建可写流" aria-label="Permalink to &quot;**2. 创建可写流**&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> writeStream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createWriteStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;output.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  flags: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;a&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 追加模式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  encoding: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utf8&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><ul><li><strong>示例</strong>：创建追加写入的流，文件不存在时自动创建。</li></ul><hr><h3 id="_3-写入数据" tabindex="-1"><strong>3. 写入数据</strong> <a class="header-anchor" href="#_3-写入数据" aria-label="Permalink to &quot;**3. 写入数据**&quot;">​</a></h3><p>使用 <code>write</code> 方法写入数据：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">writeStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Hello, World!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utf8&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> err;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;数据已写入&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><ul><li><strong>参数</strong>： <ul><li><code>data</code>: 要写入的数据（字符串、Buffer 等）。</li><li><code>encoding</code>: 编码（可选）。</li><li><code>callback</code>: 写入完成后的回调（可选）。</li></ul></li></ul><hr><h3 id="_4-处理背压-backpressure" tabindex="-1"><strong>4. 处理背压（Backpressure）</strong> <a class="header-anchor" href="#_4-处理背压-backpressure" aria-label="Permalink to &quot;**4. 处理背压（Backpressure）**&quot;">​</a></h3><p>当写入速度跟不上数据生成速度时，<code>write</code> 返回 <code>false</code>，此时应暂停写入，监听 <code>drain</code> 事件：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Large data...&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> writeData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ok) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> writeStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utf8&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    writeStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">once</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;drain&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, writeData); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 缓冲区清空后继续写入</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">writeData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><hr><h3 id="_5-结束写入" tabindex="-1"><strong>5. 结束写入</strong> <a class="header-anchor" href="#_5-结束写入" aria-label="Permalink to &quot;**5. 结束写入**&quot;">​</a></h3><p>使用 <code>end</code> 方法终止流并关闭文件：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">writeStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;最后的数据</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utf8&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;写入完成，流已关闭&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><ul><li><strong>参数</strong>：与 <code>write</code> 相同，最后的数据可选。</li></ul><hr><h3 id="_6-事件监听" tabindex="-1"><strong>6. 事件监听</strong> <a class="header-anchor" href="#_6-事件监听" aria-label="Permalink to &quot;**6. 事件监听**&quot;">​</a></h3><ul><li><strong>open</strong>: 文件打开时触发。</li><li><strong>ready</strong>: 流准备好时触发。</li><li><strong>finish</strong>: 所有数据写入完成后触发。</li><li><strong>close</strong>: 流关闭后触发。</li><li><strong>error</strong>: 发生错误时触发。</li></ul><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">writeStream</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;open&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;文件已打开&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;错误:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, err))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;finish&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;所有数据已写入&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;close&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;流已关闭&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span></code></pre></div><hr><h3 id="_7-示例-复制文件" tabindex="-1"><strong>7. 示例：复制文件</strong> <a class="header-anchor" href="#_7-示例-复制文件" aria-label="Permalink to &quot;**7. 示例：复制文件**&quot;">​</a></h3><p>结合可读流和管道操作：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> readStream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createReadStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;source.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> writeStream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createWriteStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;copy.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writeStream); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 自动处理背压和关闭</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">writeStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;finish&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;文件复制完成&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><hr><h3 id="_8-注意事项" tabindex="-1"><strong>8. 注意事项</strong> <a class="header-anchor" href="#_8-注意事项" aria-label="Permalink to &quot;**8. 注意事项**&quot;">​</a></h3><ul><li><strong>错误处理</strong>：始终监听 <code>error</code> 事件，避免程序崩溃。</li><li><strong>资源释放</strong>：使用 <code>autoClose: true</code> 或手动调用 <code>destroy()</code> 确保流关闭。</li><li><strong>性能优化</strong>：处理大文件时，利用流的分块传输减少内存占用。</li></ul><hr><p>通过 <code>fs.createWriteStream</code>，Node.js 能够高效处理文件写入，尤其适合大文件或实时数据流场景。</p><h2 id="fs-createreadstream" tabindex="-1">fs.createReadStream <a class="header-anchor" href="#fs-createreadstream" aria-label="Permalink to &quot;fs.createReadStream&quot;">​</a></h2><p>在 Node.js 中，<code>fs.createReadStream</code> 是用于 <strong>高效分块读取文件</strong> 的核心方法。它通过流式处理（Stream）机制，允许逐步读取大文件而无需一次性加载整个文件到内存。以下是详细解析：</p><hr><h3 id="_1-方法定义-1" tabindex="-1"><strong>1. 方法定义</strong> <a class="header-anchor" href="#_1-方法定义-1" aria-label="Permalink to &quot;**1. 方法定义**&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;fs&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> readStream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createReadStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(path[, options]);</span></span></code></pre></div><ul><li><strong>参数</strong>： <ul><li><code>path</code> (字符串 | Buffer | URL): 要读取的文件路径。</li><li><code>options</code> (对象，可选): 配置选项，常见属性： <ul><li><code>flags</code>: 文件操作标志（默认 <code>&#39;r&#39;</code>，只读）。</li><li><code>encoding</code>: 编码格式（默认 <code>null</code>，返回 Buffer）。</li><li><code>start</code>: 读取起始字节位置。</li><li><code>end</code>: 读取结束字节位置。</li><li><code>highWaterMark</code>: 内部缓冲区大小（默认 64KB）。</li><li><code>autoClose</code>: 是否自动关闭流（默认 <code>true</code>）。</li></ul></li></ul></li></ul><hr><h3 id="_2-创建可读流" tabindex="-1"><strong>2. 创建可读流</strong> <a class="header-anchor" href="#_2-创建可读流" aria-label="Permalink to &quot;**2. 创建可读流**&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> readStream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createReadStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;large-file.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  encoding: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utf8&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  highWaterMark: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 每次读取 1MB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><ul><li><strong>示例</strong>：读取 <code>large-file.txt</code>，每次读取 1MB 数据块。</li></ul><hr><h3 id="_3-读取数据的事件机制" tabindex="-1"><strong>3. 读取数据的事件机制</strong> <a class="header-anchor" href="#_3-读取数据的事件机制" aria-label="Permalink to &quot;**3. 读取数据的事件机制**&quot;">​</a></h3><h4 id="_1-data-事件" tabindex="-1"><strong>(1) <code>data</code> 事件</strong> <a class="header-anchor" href="#_1-data-事件" aria-label="Permalink to &quot;**(1) `data` 事件**&quot;">​</a></h4><p>当有数据可读时触发，传递数据块：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;data&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">chunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;收到数据块，大小:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, chunk.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><h4 id="_2-end-事件" tabindex="-1"><strong>(2) <code>end</code> 事件</strong> <a class="header-anchor" href="#_2-end-事件" aria-label="Permalink to &quot;**(2) `end` 事件**&quot;">​</a></h4><p>当文件全部读取完成时触发：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;end&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;文件读取完成&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><h4 id="_3-error-事件" tabindex="-1"><strong>(3) <code>error</code> 事件</strong> <a class="header-anchor" href="#_3-error-事件" aria-label="Permalink to &quot;**(3) `error` 事件**&quot;">​</a></h4><p>读取过程中发生错误时触发：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;读取失败:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, err);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><hr><h3 id="_4-分块读取的底层原理" tabindex="-1"><strong>4. 分块读取的底层原理</strong> <a class="header-anchor" href="#_4-分块读取的底层原理" aria-label="Permalink to &quot;**4. 分块读取的底层原理**&quot;">​</a></h3><ul><li><p><strong>缓冲区机制</strong>：根据 <code>highWaterMark</code> 值分块读取文件。</p></li><li><p><strong>背压（Backpressure）处理</strong>：如果数据消费速度跟不上读取速度，可读流会自动暂停读取。</p></li><li><p><strong>手动控制流</strong>：通过 <code>pause()</code> 和 <code>resume()</code> 方法：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pause</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 暂停读取</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">resume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1秒后恢复</span></span></code></pre></div></li></ul><hr><h3 id="_5-核心使用场景" tabindex="-1"><strong>5. 核心使用场景</strong> <a class="header-anchor" href="#_5-核心使用场景" aria-label="Permalink to &quot;**5. 核心使用场景**&quot;">​</a></h3><h4 id="_1-逐行处理日志文件" tabindex="-1"><strong>(1) 逐行处理日志文件</strong> <a class="header-anchor" href="#_1-逐行处理日志文件" aria-label="Permalink to &quot;**(1) 逐行处理日志文件**&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> readline</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;readline&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> rl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> readline.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createInterface</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ input: readStream });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rl.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;line&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">line</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;当前行:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, line);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><h4 id="_2-文件复制-结合可写流" tabindex="-1"><strong>(2) 文件复制（结合可写流）</strong> <a class="header-anchor" href="#_2-文件复制-结合可写流" aria-label="Permalink to &quot;**(2) 文件复制（结合可写流）**&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> writeStream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createWriteStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;copy.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writeStream); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 自动处理背压和关闭</span></span></code></pre></div><h4 id="_3-分块处理大文件" tabindex="-1"><strong>(3) 分块处理大文件</strong> <a class="header-anchor" href="#_3-分块处理大文件" aria-label="Permalink to &quot;**(3) 分块处理大文件**&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;data&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">chunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  processChunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(chunk); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 自定义处理函数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><hr><h3 id="_6-高级选项详解" tabindex="-1"><strong>6. 高级选项详解</strong> <a class="header-anchor" href="#_6-高级选项详解" aria-label="Permalink to &quot;**6. 高级选项详解**&quot;">​</a></h3><h4 id="_1-读取文件片段" tabindex="-1"><strong>(1) 读取文件片段</strong> <a class="header-anchor" href="#_1-读取文件片段" aria-label="Permalink to &quot;**(1) 读取文件片段**&quot;">​</a></h4><p>读取文件的 100~200 字节：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> readStream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createReadStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;file.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  start: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  end: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">200</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><h4 id="_2-二进制模式" tabindex="-1"><strong>(2) 二进制模式</strong> <a class="header-anchor" href="#_2-二进制模式" aria-label="Permalink to &quot;**(2) 二进制模式**&quot;">​</a></h4><p>直接读取 Buffer（默认行为）：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;data&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">chunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(chunk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><h4 id="_3-非阻塞读取" tabindex="-1"><strong>(3) 非阻塞读取</strong> <a class="header-anchor" href="#_3-非阻塞读取" aria-label="Permalink to &quot;**(3) 非阻塞读取**&quot;">​</a></h4><p>异步读取数据，不阻塞事件循环。</p><hr><h3 id="_7-完整示例" tabindex="-1"><strong>7. 完整示例</strong> <a class="header-anchor" href="#_7-完整示例" aria-label="Permalink to &quot;**7. 完整示例**&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;fs&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 创建可读流</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> readStream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createReadStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;input.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { encoding: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utf8&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 监听事件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;data&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">chunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;收到数据:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, chunk.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39; 字符&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;end&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;读取完成&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;错误:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, err);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 手动控制流（可选）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pause</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">resume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><hr><h3 id="_8-性能优化建议" tabindex="-1"><strong>8. 性能优化建议</strong> <a class="header-anchor" href="#_8-性能优化建议" aria-label="Permalink to &quot;**8. 性能优化建议**&quot;">​</a></h3><ul><li><strong>调整 <code>highWaterMark</code></strong>：根据内存和性能需求平衡缓冲区大小。</li><li><strong>使用管道（Pipe）</strong>：<code>readStream.pipe(writeStream)</code> 自动处理背压。</li><li><strong>避免同步操作</strong>：在事件回调中不要执行阻塞操作。</li></ul><hr><p>通过 <code>fs.createReadStream</code>，你可以高效处理大文件操作，避免内存溢出，同时充分利用 Node.js 的非阻塞 I/O 特性。</p><h2 id="readstream-pipe" tabindex="-1">readStream.pipe <a class="header-anchor" href="#readstream-pipe" aria-label="Permalink to &quot;readStream.pipe&quot;">​</a></h2><p>在 Node.js 中，<code>readStream.pipe()</code> 是流（Stream）操作的核心方法，用于<strong>将可读流（Readable Stream）的数据自动传输到可写流（Writable Stream）</strong>。它简化了数据流动的管理，高效处理大文件或实时数据流，同时自动优化内存使用和背压（backpressure）。</p><hr><h3 id="_1-基础语法" tabindex="-1"><strong>1. 基础语法</strong> <a class="header-anchor" href="#_1-基础语法" aria-label="Permalink to &quot;**1. 基础语法**&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readableStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writableStream[, options]);</span></span></code></pre></div><ul><li><strong>参数</strong>： <ul><li><code>writableStream</code>: 目标可写流（如文件流、HTTP 响应、压缩流等）。</li><li><code>options</code>: 可选配置（如 <code>end: false</code> 表示不自动关闭目标流）。</li></ul></li><li><strong>返回值</strong>: 目标流，支持链式调用（如 <code>a.pipe(b).pipe(c)</code>）。</li></ul><hr><h3 id="_2-核心功能" tabindex="-1"><strong>2. 核心功能</strong> <a class="header-anchor" href="#_2-核心功能" aria-label="Permalink to &quot;**2. 核心功能**&quot;">​</a></h3><h4 id="_1-自动数据传输" tabindex="-1"><strong>(1) 自动数据传输</strong> <a class="header-anchor" href="#_1-自动数据传输" aria-label="Permalink to &quot;**(1) 自动数据传输**&quot;">​</a></h4><p>将可读流的数据分块传输到可写流：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;fs&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> readStream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createReadStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;input.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> writeStream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createWriteStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;output.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writeStream); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 文件复制</span></span></code></pre></div><h4 id="_2-自动背压处理" tabindex="-1"><strong>(2) 自动背压处理</strong> <a class="header-anchor" href="#_2-自动背压处理" aria-label="Permalink to &quot;**(2) 自动背压处理**&quot;">​</a></h4><ul><li>当可写流处理速度较慢时，自动暂停可读流的数据读取。</li><li>当可写流缓冲区清空后，自动恢复可读流的读取。</li></ul><h4 id="_3-自动关闭流" tabindex="-1"><strong>(3) 自动关闭流</strong> <a class="header-anchor" href="#_3-自动关闭流" aria-label="Permalink to &quot;**(3) 自动关闭流**&quot;">​</a></h4><p>默认情况下，当可读流结束时，目标可写流会自动关闭。可通过 <code>end: false</code> 禁用：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writeStream, { end: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;end&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  writeStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;最后的数据&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 手动关闭</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><hr><h3 id="_3-典型使用场景" tabindex="-1"><strong>3. 典型使用场景</strong> <a class="header-anchor" href="#_3-典型使用场景" aria-label="Permalink to &quot;**3. 典型使用场景**&quot;">​</a></h3><h4 id="_1-文件复制" tabindex="-1"><strong>(1) 文件复制</strong> <a class="header-anchor" href="#_1-文件复制" aria-label="Permalink to &quot;**(1) 文件复制**&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;fs&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createReadStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;source.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createWriteStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;copy.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span></code></pre></div><h4 id="_2-http-文件传输" tabindex="-1"><strong>(2) HTTP 文件传输</strong> <a class="header-anchor" href="#_2-http-文件传输" aria-label="Permalink to &quot;**(2) HTTP 文件传输**&quot;">​</a></h4><p>将文件流式传输到 HTTP 响应：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> http</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;http&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createServer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createReadStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;large-video.mp4&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(res); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 自动处理分块传输</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">listen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h4 id="_3-数据压缩传输" tabindex="-1"><strong>(3) 数据压缩传输</strong> <a class="header-anchor" href="#_3-数据压缩传输" aria-label="Permalink to &quot;**(3) 数据压缩传输**&quot;">​</a></h4><p>结合压缩流（如 Gzip）：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> zlib</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;zlib&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createReadStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;data.log&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(zlib.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createGzip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 压缩数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createWriteStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;data.log.gz&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span></code></pre></div><hr><h3 id="_4-错误处理" tabindex="-1"><strong>4. 错误处理</strong> <a class="header-anchor" href="#_4-错误处理" aria-label="Permalink to &quot;**4. 错误处理**&quot;">​</a></h3><p><code>pipe</code> <strong>不会自动处理错误</strong>，需手动监听错误事件：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writeStream)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;传输失败:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, err);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 清理资源（如删除未完全写入的文件）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span></code></pre></div><hr><h3 id="_5-与手动数据处理的对比" tabindex="-1"><strong>5. 与手动数据处理的对比</strong> <a class="header-anchor" href="#_5-与手动数据处理的对比" aria-label="Permalink to &quot;**5. 与手动数据处理的对比**&quot;">​</a></h3><h4 id="使用-pipe-的简洁写法" tabindex="-1"><strong>使用 <code>pipe</code> 的简洁写法</strong>： <a class="header-anchor" href="#使用-pipe-的简洁写法" aria-label="Permalink to &quot;**使用 `pipe` 的简洁写法**：&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writeStream);</span></span></code></pre></div><h4 id="等效的手动实现" tabindex="-1"><strong>等效的手动实现</strong>： <a class="header-anchor" href="#等效的手动实现" aria-label="Permalink to &quot;**等效的手动实现**：&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;data&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">chunk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> canContinue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> writeStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(chunk);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">canContinue) { </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 处理背压</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pause</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    writeStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">once</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;drain&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">resume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">readStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;end&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> writeStream.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span></code></pre></div><hr><h3 id="_6-进阶用法" tabindex="-1"><strong>6. 进阶用法</strong> <a class="header-anchor" href="#_6-进阶用法" aria-label="Permalink to &quot;**6. 进阶用法**&quot;">​</a></h3><h4 id="_1-链式管道-处理多个流" tabindex="-1"><strong>(1) 链式管道（处理多个流）</strong> <a class="header-anchor" href="#_1-链式管道-处理多个流" aria-label="Permalink to &quot;**(1) 链式管道（处理多个流）**&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> crypto</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;crypto&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createReadStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;data.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(crypto.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createCipher</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;aes192&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;密钥&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 加密</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(zlib.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createGzip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 压缩</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createWriteStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;data.enc.gz&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span></code></pre></div><h4 id="_2-使用-pipeline-替代-pipe-推荐" tabindex="-1"><strong>(2) 使用 <code>pipeline</code> 替代 <code>pipe</code>（推荐）</strong> <a class="header-anchor" href="#_2-使用-pipeline-替代-pipe-推荐" aria-label="Permalink to &quot;**(2) 使用 `pipeline` 替代 `pipe`（推荐）**&quot;">​</a></h4><p>Node.js 10+ 提供更安全的 <code>stream.pipeline</code>：</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pipeline</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;stream&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pipeline</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createReadStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;input.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  zlib.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createGzip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createWriteStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;output.txt.gz&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err) console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;管道链错误:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, err);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;处理完成&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><hr><h3 id="_7-注意事项" tabindex="-1"><strong>7. 注意事项</strong> <a class="header-anchor" href="#_7-注意事项" aria-label="Permalink to &quot;**7. 注意事项**&quot;">​</a></h3><ul><li><strong>内存优化</strong>：<code>pipe</code> 的默认 <code>highWaterMark</code>（缓冲区大小）为 64KB，可通过流构造函数调整。</li><li><strong>目标流不可写时</strong>：尝试写入会触发错误，需确保目标流处于可写状态。</li><li><strong>不适用于对象模式流</strong>：<code>pipe</code> 默认处理 Buffer/String，对象模式流需特殊处理。</li></ul><hr><h3 id="总结-6" tabindex="-1"><strong>总结</strong> <a class="header-anchor" href="#总结-6" aria-label="Permalink to &quot;**总结**&quot;">​</a></h3><p><code>readStream.pipe()</code> 是 Node.js 流式编程的基石，通过自动化数据传输、背压管理和资源释放，显著简化了流操作。它适用于文件处理、网络通信、数据转换等场景，是处理大数据的首选方案。</p><h2 id="fs-unlinksync" tabindex="-1">fs.unlinkSync <a class="header-anchor" href="#fs-unlinksync" aria-label="Permalink to &quot;fs.unlinkSync&quot;">​</a></h2><p>在 Node.js 中，<code>fs.unlinkSync</code> 是 <code>fs</code> 模块提供的一个 <strong>同步方法</strong>，用于 <strong>删除文件或符号链接（symbolic link）</strong>。它会阻塞后续代码的执行，直到文件被删除完成或发生错误。以下是详细解析：</p><hr><h3 id="_1-方法定义-2" tabindex="-1"><strong>1. 方法定义</strong> <a class="header-anchor" href="#_1-方法定义-2" aria-label="Permalink to &quot;**1. 方法定义**&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;fs&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unlinkSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(path);</span></span></code></pre></div><ul><li><strong>参数</strong>： <ul><li><code>path</code> (字符串 | Buffer | URL): 要删除的文件或符号链接的路径。</li></ul></li><li><strong>返回值</strong>：无。若操作失败，直接抛出错误（需用 <code>try/catch</code> 捕获）。</li></ul><hr><h3 id="_2-核心功能-1" tabindex="-1"><strong>2. 核心功能</strong> <a class="header-anchor" href="#_2-核心功能-1" aria-label="Permalink to &quot;**2. 核心功能**&quot;">​</a></h3><ul><li><strong>删除文件</strong>：永久删除指定路径的文件。</li><li><strong>删除符号链接</strong>：仅删除符号链接本身，不影响其指向的目标文件或目录。</li><li><strong>同步操作</strong>：立即执行删除，阻塞事件循环直到完成。</li></ul><hr><h3 id="_3-使用示例" tabindex="-1"><strong>3. 使用示例</strong> <a class="header-anchor" href="#_3-使用示例" aria-label="Permalink to &quot;**3. 使用示例**&quot;">​</a></h3><h4 id="_1-删除文件" tabindex="-1"><strong>(1) 删除文件</strong> <a class="header-anchor" href="#_1-删除文件" aria-label="Permalink to &quot;**(1) 删除文件**&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;fs&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;path&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> filePath</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> path.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(__dirname, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;temp.txt&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unlinkSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filePath);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;文件已删除&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;删除失败:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, err.message);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_2-删除符号链接" tabindex="-1"><strong>(2) 删除符号链接</strong> <a class="header-anchor" href="#_2-删除符号链接" aria-label="Permalink to &quot;**(2) 删除符号链接**&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> linkPath</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> path.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(__dirname, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;symlink-to-file&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unlinkSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(linkPath); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 删除符号链接，不删除目标文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 处理错误</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h3 id="_4-错误处理-1" tabindex="-1"><strong>4. 错误处理</strong> <a class="header-anchor" href="#_4-错误处理-1" aria-label="Permalink to &quot;**4. 错误处理**&quot;">​</a></h3><ul><li><strong>常见错误类型</strong>： <ul><li><code>ENOENT</code>: 文件不存在。</li><li><code>EACCES</code>: 权限不足。</li><li><code>EPERM</code>: 文件是目录（需用 <code>fs.rmdirSync</code> 或 <code>fs.rmSync</code> 删除目录）。</li></ul></li><li><strong>强制使用 <code>try/catch</code></strong>：同步方法必须捕获异常，否则进程会崩溃。</li></ul><hr><h3 id="_5-同步-vs-异步" tabindex="-1"><strong>5. 同步 vs 异步</strong> <a class="header-anchor" href="#_5-同步-vs-异步" aria-label="Permalink to &quot;**5. 同步 vs 异步**&quot;">​</a></h3><table tabindex="0"><thead><tr><th><strong>特性</strong></th><th><code>fs.unlinkSync</code> (同步)</th><th><code>fs.unlink</code> (异步)</th></tr></thead><tbody><tr><td><strong>执行方式</strong></td><td>阻塞后续代码，直到删除完成或失败</td><td>非阻塞，通过回调通知结果</td></tr><tr><td><strong>错误处理</strong></td><td>必须用 <code>try/catch</code> 捕获</td><td>通过回调函数的 <code>err</code> 参数处理</td></tr><tr><td><strong>适用场景</strong></td><td>简单脚本、需立即确认删除结果的场景</td><td>服务器应用、需避免阻塞事件循环的场景</td></tr></tbody></table><hr><h3 id="_6-删除目录的注意事项" tabindex="-1"><strong>6. 删除目录的注意事项</strong> <a class="header-anchor" href="#_6-删除目录的注意事项" aria-label="Permalink to &quot;**6. 删除目录的注意事项**&quot;">​</a></h3><ul><li><p><strong>无法删除目录</strong>：<code>fs.unlinkSync</code> 仅适用于文件和符号链接。若路径是目录，会抛出 <code>EPERM</code> 或 <code>EISDIR</code> 错误。</p></li><li><p><strong>正确做法</strong>：使用 <code>fs.rmdirSync</code>（仅空目录）或 <code>fs.rmSync</code>（递归删除目录及内容，Node.js ≥14.14.0）。</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 删除空目录</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rmdirSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dirPath);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 递归删除目录（包括子文件和子目录）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rmSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dirPath, { recursive: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, force: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span></code></pre></div></li></ul><hr><h3 id="_7-实战建议" tabindex="-1"><strong>7. 实战建议</strong> <a class="header-anchor" href="#_7-实战建议" aria-label="Permalink to &quot;**7. 实战建议**&quot;">​</a></h3><ul><li><strong>优先使用异步方法</strong>：在服务器或高性能应用中，避免阻塞事件循环。</li><li><strong>同步方法的适用场景</strong>： <ul><li>命令行工具脚本。</li><li>需确保删除完成后再执行后续逻辑的简单操作。</li><li>初始化/清理阶段的同步任务。</li></ul></li><li><strong>检查文件是否存在</strong>：删除前可先调用 <code>fs.existsSync</code>（但存在竞态条件风险）。</li></ul><hr><h3 id="总结-7" tabindex="-1"><strong>总结</strong> <a class="header-anchor" href="#总结-7" aria-label="Permalink to &quot;**总结**&quot;">​</a></h3><ul><li><code>fs.unlinkSync</code> 是同步删除文件或符号链接的直接方式。</li><li>必须用 <code>try/catch</code> 处理潜在错误（如文件不存在、权限问题）。</li><li>删除目录需使用 <code>fs.rmdirSync</code> 或 <code>fs.rmSync</code>。</li><li>在多数应用中，异步方法 <code>fs.unlink</code> 是更安全的选择。</li></ul></div></div></main><footer class="VPDocFooter" data-v-4a2b1bc7 data-v-e52188cc><!--[--><!--]--><div class="edit-info" data-v-e52188cc><div class="edit-link" data-v-e52188cc><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/yourname/repo/edit/main/docs/file-note.md" target="_blank" rel="noreferrer" data-v-e52188cc><!--[--><span class="vpi-square-pen edit-link-icon" data-v-e52188cc></span> 在 GitHub 上编辑此页<!--]--></a></div><div class="last-updated" data-v-e52188cc><p class="VPLastUpdated" data-v-e52188cc data-v-0b62f736>最后更新于: <time datetime="2025-05-18T12:14:46.000Z" data-v-0b62f736></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e52188cc><span class="visually-hidden" id="doc-footer-aria-label" data-v-e52188cc>Pager</span><div class="pager" data-v-e52188cc><a class="VPLink link pager-link prev" href="/docs/file-code.html" data-v-e52188cc><!--[--><span class="desc" data-v-e52188cc>Previous page</span><span class="title" data-v-e52188cc>文件上传代码</span><!--]--></a></div><div class="pager" data-v-e52188cc><a class="VPLink link pager-link next" href="/docs/tracking-code.html" data-v-e52188cc><!--[--><span class="desc" data-v-e52188cc>Next page</span><span class="title" data-v-e52188cc>埋点核心代码</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-9e0dc340 data-v-ad24febc><div class="container" data-v-ad24febc><p class="message" data-v-ad24febc>Released under the MIT License.</p><p class="copyright" data-v-ad24febc>Copyright © 2023-present My Project</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"file-code.md\":\"BTO79o9R\",\"file-note.md\":\"Bma2zlnX\",\"index.md\":\"DjwALgGf\",\"jq-code.md\":\"CCk1tLpA\",\"readme.md\":\"aUBrCMOo\",\"tracking-code.md\":\"BZsukeZc\",\"tracking-note.md\":\"C36WwrvJ\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"My Awesome Project111\",\"description\":\"A VitePress Site111\",\"base\":\"/docs/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Home\",\"link\":\"/\"},{\"text\":\"埋点代码\",\"link\":\"/tracking-code\"}],\"sidebar\":[{\"text\":\"文件上传\",\"items\":[{\"text\":\"文件上传代码\",\"link\":\"/file-code\"},{\"text\":\"文件上传笔记\",\"link\":\"/file-note\"}]},{\"text\":\"埋点\",\"items\":[{\"text\":\"埋点核心代码\",\"link\":\"/tracking-code\"},{\"text\":\"埋点笔记\",\"link\":\"/tracking-note\"}]},{\"text\":\"jQuery\",\"items\":[{\"text\":\"jQuery代码\",\"link\":\"/jq-code\"}]}],\"search\":{\"provider\":\"local\"},\"lastUpdated\":{\"text\":\"最后更新于\",\"formatOptions\":{\"year\":\"numeric\",\"month\":\"short\",\"day\":\"numeric\"}},\"footer\":{\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright © 2023-present My Project\"},\"editLink\":{\"pattern\":\"https://github.com/yourname/repo/edit/main/docs/:path\",\"text\":\"在 GitHub 上编辑此页\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/vuejs/vitepress\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>